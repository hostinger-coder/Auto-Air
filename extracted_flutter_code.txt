// ===== lib/auth_gate.dart =====

import 'package:flutter/material.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:provider/provider.dart';
import 'api/api_service.dart';
import 'providers/device_provider.dart';

class AuthGate extends StatefulWidget {
  const AuthGate({Key? key}) : super(key: key);

  @override
  State<AuthGate> createState() => _AuthGateState();
}

class _AuthGateState extends State<AuthGate> {
  final _storage = const FlutterSecureStorage();
  final _api = ApiService();

  @override
  void initState() {
    super.initState();
    _check();
  }

  Future<void> _check() async {
    await Future.delayed(const Duration(milliseconds: 600));
    final token = await _storage.read(key: 'auth_token');
    if (!mounted) return;
    if (token == null) {
      Navigator.of(context).pushNamedAndRemoveUntil('/login', (route) => false);
      return;
    }
    final ok = await _api.authenticate();
    if (!mounted) return;
    if (ok) {
      final provider = Provider.of<DeviceProvider>(context, listen: false);
      final hasDevice = await provider.loadInitialDevice();
      if (!mounted) return;
      if (hasDevice) {
        Navigator.of(context).pushNamedAndRemoveUntil('/dashboard', (route) => false);
      } else {
        Navigator.of(context).pushNamedAndRemoveUntil('/device_list', (route) => false);
      }
    } else {
      await _storage.delete(key: 'auth_token');
      Navigator.of(context).pushNamedAndRemoveUntil('/login', (route) => false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      body: Center(child: CircularProgressIndicator()),
    );
  }
}

// ===== lib/main.dart =====

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'features/authentication/screens/signup_screen.dart';
import 'features/authentication/screens/login_screen.dart';
import 'features/authentication/screens/forgot_password_screen.dart';
import 'features/dashboard/screens/dashboard_screen.dart';
import 'features/devices/screens/add_device_screen.dart';
import 'features/devices/screens/device_list_screen.dart';
import 'features/setup/screens/system_time_screen.dart';
import 'features/setup/screens/wifi_onboarding_screen.dart';
import 'features/setup/screens/wifi_scan_screen.dart';
import 'features/setup/screens/wifi_password_screen.dart';
import 'features/dashboard/screens/relay_schedule_screen.dart';
import 'features/dashboard/screens/hourly_records_screen.dart';
import 'features/dashboard/screens/firmware_update_screen.dart';
import 'providers/dashboard_provider.dart';
import 'providers/device_provider.dart';
import 'themes.dart';
import 'auth_gate.dart';
import 'navigation_service.dart';

void main() {
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => DeviceProvider()),
        ChangeNotifierProxyProvider<DeviceProvider, DashboardProvider>(
          create: (context) => DashboardProvider(
            Provider.of<DeviceProvider>(context, listen: false),
          ),
          update: (context, deviceProvider, dashboardProvider) =>
              DashboardProvider(deviceProvider),
        ),
      ],
      child: const MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: AppThemes.lightTheme,
      darkTheme: AppThemes.darkTheme,
      themeMode: ThemeMode.dark,
      navigatorKey: navigatorKey,
      initialRoute: '/auth_gate',
      routes: {
        '/auth_gate': (context) => const AuthGate(),
        '/signup': (context) => const SignUpScreen(),
        '/login': (context) => const LoginScreen(),
        '/forgot_password': (context) => const ForgotPasswordScreen(),
        '/dashboard': (context) => const DashboardScreen(),
        '/device_list': (context) => const DeviceListScreen(),
        '/add_device': (context) => const AddDeviceScreen(),
        '/system_time': (context) => const SystemTimeScreen(),
        '/wifi_onboarding': (context) => const WifiOnboardingScreen(),
        '/wifi_scan': (context) => const WifiScanScreen(),
        '/wifi_password': (context) => const WifiPasswordScreen(),
        '/relay_schedule': (context) => const RelayScheduleScreen(),
        '/hourly_records': (context) => const HourlyRecordsScreen(),
        '/firmware_update': (context) => const FirmwareUpdateScreen(),
      },
    );
  }
}

// ===== lib/navigation_service.dart =====

import 'package:flutter/material.dart';

final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

// ===== lib/themes.dart =====

import 'package:flutter/material.dart';
import 'themes/custom_colors.dart';

class AppThemes {
  static final ThemeData darkTheme = ThemeData(
    brightness: Brightness.dark,

    extensions: const <ThemeExtension<dynamic>>[
      CustomColors(
        primaryAction: Colors.deepPurple,
        secondaryButton: Color(0xFF1A1A1A),
        success: Color(0xFF22C55E),
        successTrack: Color(0x7322C55E),
        successBorder: Color(0x5922C55E),
      ),
    ],

    scaffoldBackgroundColor: Colors.black,
    primaryColor: const Color(0xFF531DAB),

    colorScheme: const ColorScheme.dark(
      primary: Color(0xFF531DAB),
      secondary: Color(0xFF1A1A1A),
      onPrimary: Colors.white,
      onSecondary: Colors.white,
      surface: Colors.black,
    ),

    fontFamily: 'Roboto',

    textTheme: const TextTheme(
      displayLarge: TextStyle(fontSize: 32, fontWeight: FontWeight.bold, color: Colors.white),
      bodyLarge: TextStyle(fontSize: 18, color: Colors.white),
      bodyMedium: TextStyle(color: Colors.white70, fontWeight: FontWeight.bold),
    ),

    inputDecorationTheme: InputDecorationTheme(
      hintStyle: TextStyle(color: Colors.grey.shade500),
      filled: true,
      fillColor: Colors.black,
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10.0),
        borderSide: const BorderSide(color: Color(0xFF2A2F3A)),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10.0),
        borderSide: const BorderSide(color: Color(0xFF6A1B9A)),
      ),
      prefixIconColor: Colors.grey.shade600,
      suffixIconColor: Colors.grey.shade600,
    ),

    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        backgroundColor: const Color(0xFF531DAB),
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(vertical: 16.0),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10.0),
        ),
        textStyle: const TextStyle(fontSize: 18, color: Colors.white),
      ),
    ),

    outlinedButtonTheme: OutlinedButtonThemeData(
      style: OutlinedButton.styleFrom(
        side: BorderSide.none,
        backgroundColor: const Color(0xFF1A1A1A),
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(vertical: 16.0),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10.0),
        ),
        textStyle: const TextStyle(fontSize: 18, color: Colors.white),
      ),
    ),

    dividerTheme: const DividerThemeData(
      color: Colors.white70,
      thickness: 2,
    ),
  );

  static final ThemeData lightTheme = ThemeData(
    brightness: Brightness.light,

    extensions: const <ThemeExtension<dynamic>>[
      CustomColors(
        primaryAction: Colors.deepPurple,
        secondaryButton: Color(0xFFE0E0E0),
        success: Color(0xFF16A34A),
        successTrack: Color(0x6616A34A),
        successBorder: Color(0x4D16A34A),
      ),
    ],

    scaffoldBackgroundColor: const Color(0xFFF5F5F5),
    primaryColor: const Color(0xFF531DAB),

    colorScheme: const ColorScheme.light(
      primary: Color(0xFF531DAB),
      secondary: Color(0xFFE0E0E0),
      onPrimary: Colors.white,
      onSecondary: Colors.black,
      surface: Colors.white,
    ),

    fontFamily: 'Roboto',

    textTheme: const TextTheme(
      displayLarge: TextStyle(fontSize: 32, fontWeight: FontWeight.bold, color: Colors.black),
      bodyLarge: TextStyle(fontSize: 18, color: Colors.black),
      bodyMedium: TextStyle(color: Colors.black54, fontWeight: FontWeight.bold),
    ),

    inputDecorationTheme: InputDecorationTheme(
      hintStyle: TextStyle(color: Colors.grey.shade500),
      filled: true,
      fillColor: Colors.white,
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10.0),
        borderSide: const BorderSide(color: Color(0xFFBDBDBD)),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10.0),
        borderSide: const BorderSide(color: Color(0xFF6A1B9A)),
      ),
      prefixIconColor: Colors.grey.shade600,
      suffixIconColor: Colors.grey.shade600,
    ),

    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        backgroundColor: const Color(0xFF531DAB),
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(vertical: 16.0),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10.0),
        ),
        textStyle: const TextStyle(fontSize: 18, color: Colors.white),
      ),
    ),

    outlinedButtonTheme: OutlinedButtonThemeData(
      style: OutlinedButton.styleFrom(
        side: BorderSide.none,
        backgroundColor: const Color(0xFFE0E0E0),
        foregroundColor: Colors.black,
        padding: const EdgeInsets.symmetric(vertical: 16.0),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10.0),
        ),
        textStyle: const TextStyle(fontSize: 18, color: Colors.black),
      ),
    ),

    dividerTheme: const DividerThemeData(
      color: Colors.black54,
      thickness: 2,
    ),
  );
}


// ===== lib/api/api_service.dart =====

import 'dart:io';
import 'package:dio/dio.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:flutter/foundation.dart' show kIsWeb;
import '../navigation_service.dart';

class ApiService {
  final Dio _dio;
  final FlutterSecureStorage _secureStorage;
  final DeviceInfoPlugin _deviceInfoPlugin;

  static const String _baseUrl = 'http://192.168.0.56:8001/api/v1/';
  static const String _tokenKey = 'auth_token';

  ApiService._()
      : _dio = Dio(),
        _secureStorage = const FlutterSecureStorage(),
        _deviceInfoPlugin = DeviceInfoPlugin() {
    _dio.options = BaseOptions(
      baseUrl: _baseUrl,
      headers: {'Accept': 'application/json'},
      connectTimeout: const Duration(milliseconds: 15000),
      receiveTimeout: const Duration(milliseconds: 15000),
    );

    _dio.interceptors.add(
      InterceptorsWrapper(
        onRequest: (options, handler) async {
          final token = await _secureStorage.read(key: _tokenKey);
          if (token != null) {
            options.headers['Authorization'] = 'Bearer $token';
          }
          return handler.next(options);
        },
        onError: (e, handler) async {
          if (e.response?.statusCode == 401) {
            await _secureStorage.delete(key: _tokenKey);
            navigatorKey.currentState
                ?.pushNamedAndRemoveUntil('/login', (route) => false);
            return;
          }
          return handler.next(e);
        },
      ),
    );

    _dio.interceptors.add(LogInterceptor(responseBody: true, requestBody: true));
  }

  static final ApiService _instance = ApiService._();

  factory ApiService() {
    return _instance;
  }

  Future<String> _getDeviceName() async {
    try {
      if (kIsWeb) {
        final webBrowserInfo = await _deviceInfoPlugin.webBrowserInfo;
        return webBrowserInfo.browserName.name;
      } else if (Platform.isAndroid) {
        final androidInfo = await _deviceInfoPlugin.androidInfo;
        return androidInfo.model ?? 'Android';
      } else if (Platform.isIOS) {
        final iosInfo = await _deviceInfoPlugin.iosInfo;
        return iosInfo.model ?? 'iOS';
      }
    } catch (_) {}
    return 'Unknown';
  }

  Future<void> login({required String email, required String password}) async {
    try {
      final deviceName = await _getDeviceName();
      final response = await _dio.post(
        'auth/mobile/login',
        data: {'email': email, 'password': password, 'device_name': deviceName},
      );
      final responseData = response.data['data'];
      if (response.statusCode == 200 && responseData['token'] != null) {
        await _secureStorage.write(key: _tokenKey, value: responseData['token']);
      } else {
        throw Exception('Login failed');
      }
    } on DioException catch (e) {
      if (e.response?.statusCode == 422) {
        throw Exception('Invalid credentials');
      }
      throw Exception('Network error');
    }
  }

  Future<void> register({
    required String firstName,
    required String lastName,
    required String email,
    required String password,
    required String passwordConfirmation,
  }) async {
    try {
      final deviceName = await _getDeviceName();
      final response = await _dio.post(
        'auth/mobile/register',
        data: {
          'first_name': firstName,
          'last_name': lastName,
          'email': email,
          'password': password,
          'password_confirmation': passwordConfirmation,
          'device_name': deviceName,
        },
      );
      final responseData = response.data['data'];
      if (response.statusCode == 200 && responseData['token'] != null) {
        await _secureStorage.write(key: _tokenKey, value: responseData['token']);
      } else {
        throw Exception('Registration failed');
      }
    } on DioException catch (e) {
      if (e.response?.statusCode == 422) {
        throw Exception('Invalid data');
      }
      throw Exception('Network error');
    }
  }

  Future<void> forgotPassword({required String email}) async {
    try {
      await _dio.post('auth/mobile/forgot-password', data: {'email': email});
    } on DioException catch (e) {
      if (e.response?.statusCode == 422) {
        throw Exception('Invalid email');
      }
      throw Exception('Network error');
    }
  }

  Future<void> logout() async {
    try {
      await _dio.post('auth/mobile/logout');
    } catch (_) {} finally {
      await _secureStorage.delete(key: _tokenKey);
    }
  }

  Future<bool> authenticate() async {
    try {
      final response = await _dio.get('auth/mobile/authenticate');
      return response.statusCode == 200;
    } on DioException {
      return false;
    }
  }

  Future<List<dynamic>> getDevices({Map<String, dynamic>? params}) async {
    final response = await _dio.get('devices', queryParameters: params);
    if (response.data is Map<String, dynamic> &&
        response.data['data'] is Map<String, dynamic> &&
        response.data['data']['data'] is List) {
      return List<dynamic>.from(response.data['data']['data']);
    }
    throw Exception('Invalid response format for devices.');
  }

  Future<Map<String, dynamic>> createDevice({
    required String name,
    required String serialNumber,
    required String pin,
    String? description,
  }) async {
    final response = await _dio.post('devices', data: {
      'name': name,
      'serial_number': serialNumber,
      'pin': pin,
      if (description != null) 'description': description,
    });
    return Map<String, dynamic>.from(response.data is Map<String, dynamic> && response.data['data'] != null ? response.data['data'] : response.data);
  }

  Future<Map<String, dynamic>> updateDevice({
    required String serialNumber,
    required Map<String, dynamic> data,
  }) async {
    final response = await _dio.patch('devices/$serialNumber', data: data);
    return Map<String, dynamic>.from(response.data is Map<String, dynamic> && response.data['data'] != null ? response.data['data'] : response.data);
  }

  Future<void> updateDeviceWifiConfig({
    required String deviceSerialNumber,
    required String ssid,
    required String password,
    bool isStatic = false,
    String? ipAddress,
    String? subnet,
    String? gateway,
  }) async {
    await _dio.patch('devices/$deviceSerialNumber', data: {
      'config': {
        'wifi': {
          'ssid': ssid,
          'password': password,
          'is_static': isStatic,
          if (isStatic) 'ip_address': ipAddress,
          if (isStatic) 'subnet': subnet,
          if (isStatic) 'gateway': gateway,
        }
      }
    });
  }

  Future<void> updateDeviceTimeConfig({
    required String deviceSerialNumber,
    required String isoTime,
    required String timezone,
  }) async {
    await _dio.patch('devices/$deviceSerialNumber', data: {
      'config': {
        'time': {
          'datetime': isoTime,
          'timezone': timezone,
        }
      }
    });
  }
}

// ===== lib/api/csrf_io.dart =====

import 'package:dio/dio.dart';

Map<String, String> _parseSetCookie(List<String> setCookies) {
  final map = <String, String>{};
  for (final sc in setCookies) {
    final semi = sc.split(';');
    if (semi.isEmpty) continue;
    final kv = semi.first.split('=');
    if (kv.length < 2) continue;
    final name = kv[0].trim();
    final value = kv.sublist(1).join('=').trim();
    if (name.isEmpty) continue;
    map[name] = value;
  }
  return map;
}

Future<Map<String, String>> refreshCsrf(String rootBaseUrl, String csrfPath) async {
  final d = Dio(BaseOptions(
    baseUrl: rootBaseUrl,
    headers: {'Accept': 'application/json'},
    connectTimeout: const Duration(milliseconds: 5000),
    receiveTimeout: const Duration(milliseconds: 3000),
    followRedirects: false,
  ));
  final resp = await d.get(csrfPath);
  final setCookies = resp.headers.map['set-cookie'] ?? const <String>[];
  final cookies = _parseSetCookie(setCookies);
  final token = cookies['XSRF-TOKEN'];
  if (token != null) cookies['XSRF-TOKEN'] = Uri.decodeComponent(token);
  return cookies;
}


// ===== lib/api/csrf_web.dart =====

import 'package:dio/dio.dart';
import 'dart:html' as html;

String? _readCookie(String name) {
  final cookies = html.document.cookie?.split(';') ?? const [];
  for (final raw in cookies) {
    final idx = raw.indexOf('=');
    if (idx == -1) continue;
    final k = raw.substring(0, idx).trim();
    final v = raw.substring(idx + 1);
    if (k.toLowerCase() == name.toLowerCase()) return Uri.decodeComponent(v);
  }
  return null;
}

Future<Map<String, String>> refreshCsrf(String rootBaseUrl, String csrfPath) async {
  final d = Dio(BaseOptions(
    baseUrl: rootBaseUrl,
    headers: {'Accept': 'application/json'},
    connectTimeout: const Duration(milliseconds: 5000),
    receiveTimeout: const Duration(milliseconds: 3000),
  ));
  await d.get(csrfPath);
  final xsrf = _readCookie('XSRF-TOKEN') ?? '';
  final session = _readCookie('laravel_session') ?? _readCookie('synx_session') ?? '';
  final map = <String, String>{};
  if (xsrf.isNotEmpty) map['XSRF-TOKEN'] = xsrf;
  if (session.isNotEmpty) map['laravel_session'] = session;
  return map;
}


// ===== lib/api/mqtt_service.dart =====

import 'package:flutter/foundation.dart';
import 'package:mqtt_client/mqtt_client.dart';
import 'package:mqtt_client/mqtt_server_client.dart';

class MqttService {
  late MqttServerClient _client;
  final String _broker = '192.168.0.56';
  final int _port = 1883;

  MqttService._() {
    // Initialization code can go here if needed
  }

  static final MqttService _instance = MqttService._();

  factory MqttService() {
    return _instance;
  }

  MqttServerClient get client => _client;

  Future<bool> connect(String clientId, String username, String password) async {
    _client = MqttServerClient(_broker, clientId);
    _client.port = _port;
    _client.logging(on: true);

    _client.onConnected = _onConnected;
    _client.onDisconnected = _onDisconnected;
    _client.onUnsubscribed = _onUnsubscribed;
    _client.onSubscribed = _onSubscribed;
    _client.onSubscribeFail = _onSubscribeFail;
    _client.pongCallback = _pong;
    _client.keepAlivePeriod = 60;
    _client.setProtocolV311();

    final connMessage = MqttConnectMessage()
        .withClientIdentifier(clientId)
        .withWillTopic('willtopic')
        .withWillMessage('My Will message')
        .startClean()
        .withWillQos(MqttQos.atLeastOnce)
        .authenticateAs(username, password);

    _client.connectionMessage = connMessage;

    try {
      await _client.connect();
      return _client.connectionStatus!.state == MqttConnectionState.connected;
    } on Exception catch (e) {
      debugPrint('MQTT_SERVICE::Client exception - $e');
      _client.disconnect();
      return false;
    }
  }

  void disconnect() {
    _client.disconnect();
  }

  void subscribe(String topic) {
    _client.subscribe(topic, MqttQos.atLeastOnce);
  }

  void publish(String topic, String message) {
    final builder = MqttClientPayloadBuilder();
    builder.addString(message);
    _client.publishMessage(topic, MqttQos.atLeastOnce, builder.payload!);
  }

  void _onConnected() {
    debugPrint('MQTT_SERVICE::Connected');
  }

  void _onDisconnected() {
    debugPrint('MQTT_SERVICE::Disconnected');
  }

  void _onSubscribed(String topic) {
    debugPrint('MQTT_SERVICE::Subscribed to topic: $topic');
  }

  void _onSubscribeFail(String topic) {
    debugPrint('MQTT_SERVICE::Failed to subscribe to $topic');
  }

  void _onUnsubscribed(String? topic) {
    debugPrint('MQTT_SERVICE::Unsubscribed from topic: $topic');
  }

  void _pong() {
    debugPrint('MQTT_SERVICE::Ping response received');
  }
}

// ===== lib/features/authentication/screens/forgot_password_screen.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';
import 'package:AutoAir/themes/custom_colors.dart';

class ForgotPasswordScreen extends StatefulWidget {
  const ForgotPasswordScreen({Key? key}) : super(key: key);

  @override
  State<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _apiService = ApiService();
  bool _isLoading = false;

  @override
  void dispose() {
    _emailController.dispose();
    super.dispose();
  }

  Future<void> _sendResetLink() async {
    if (!(_formKey.currentState?.validate() ?? false)) {
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      await _apiService.forgotPassword(email: _emailController.text);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('If an account exists, a reset link has been sent.'),
            backgroundColor: Colors.green,
          ),
        );
        Navigator.pushReplacementNamed(context, '/login');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(e.toString()),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;
    final customColors = theme.extension<CustomColors>()!;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          leading: IconButton(
            icon: Icon(Icons.arrow_back, color: isDarkMode ? Colors.white : Colors.black),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ),
        body: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 32.0),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: <Widget>[
                    Image.asset(AppAssets.logo, height: 80),
                    const SizedBox(height: 16),
                    Text(
                      'AutoAir',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineLarge?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 48),
                    Text(
                      'Reset Password',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineSmall?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black87,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Enter your email and we will send you a password reset link.',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.bodyMedium?.copyWith(
                          color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600,
                          fontWeight: FontWeight.normal
                      ),
                    ),
                    const SizedBox(height: 32),
                    TextFormField(
                      controller: _emailController,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _buildInputDecoration('Email', isDarkMode),
                      keyboardType: TextInputType.emailAddress,
                      validator: (value) {
                        if (value == null || value.isEmpty || !value.contains('@')) {
                          return 'Please enter a valid email';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 32),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: customColors.primaryAction,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                      ),
                      onPressed: _isLoading ? null : _sendResetLink,
                      child: _isLoading
                          ? const SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(
                          color: Colors.white,
                          strokeWidth: 2,
                        ),
                      )
                          : const Text('Send Reset Link'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  InputDecoration _buildInputDecoration(String label, bool isDarkMode) {
    return InputDecoration(
      labelText: label,
      labelStyle: TextStyle(color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600),
      filled: true,
      fillColor: isDarkMode ? Colors.grey.shade900.withOpacity(0.5) : Colors.white,
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade400 : Colors.deepPurple),
      ),
    );
  }
}

// ===== lib/features/authentication/screens/login_screen.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({Key? key}) : super(key: key);

  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _apiService = ApiService();

  bool _isPasswordObscured = true;
  bool _isLoading = false;
  bool _rememberMe = false;

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _login() async {
    if (!(_formKey.currentState?.validate() ?? false)) {
      return;
    }
    setState(() {
      _isLoading = true;
    });
    try {
      await _apiService.login(
        email: _emailController.text.trim(),
        password: _passwordController.text,
      );
      if (!mounted) return;
      Navigator.of(context).pushNamedAndRemoveUntil('/device_list', (route) => false);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.toString()), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 32.0),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: <Widget>[
                    Image.asset(AppAssets.logo, height: 80),
                    const SizedBox(height: 16),
                    Text(
                      'AutoAir',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineLarge?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 48),
                    Text(
                      'Log in Account',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineSmall?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black87,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: 32),
                    TextFormField(
                      controller: _emailController,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _buildInputDecoration('Email', isDarkMode),
                      keyboardType: TextInputType.emailAddress,
                      validator: (value) {
                        if (value == null || value.isEmpty || !value.contains('@')) {
                          return 'Enter a valid email';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 24),
                    TextFormField(
                      controller: _passwordController,
                      obscureText: _isPasswordObscured,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _buildInputDecoration('Password', isDarkMode).copyWith(
                        suffixIcon: IconButton(
                          icon: Icon(
                            _isPasswordObscured
                                ? Icons.visibility_off_outlined
                                : Icons.visibility_outlined,
                            color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600,
                          ),
                          onPressed: () {
                            setState(() {
                              _isPasswordObscured = !_isPasswordObscured;
                            });
                          },
                        ),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Enter your password';
                        }
                        return null;
                      },
                    ),
                    const SizedBox(height: 32),
                    ElevatedButton(
                      style: _buildButtonStyle(isDarkMode),
                      onPressed: _isLoading ? null : _login,
                      child: _isLoading
                          ? const SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(
                          color: Colors.white,
                          strokeWidth: 2,
                        ),
                      )
                          : const Text('Log in'),
                    ),
                    const SizedBox(height: 24),
                    _buildRememberMeRow(isDarkMode),
                    const SizedBox(height: 32),
                    _buildDividerWithText(isDarkMode),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      style: _buildButtonStyle(isDarkMode),
                      onPressed: () {
                        Navigator.of(context).pushNamedAndRemoveUntil('/signup', (route) => false);
                      },
                      child: const Text('Sign up'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  InputDecoration _buildInputDecoration(String label, bool isDarkMode) {
    return InputDecoration(
      labelText: label,
      labelStyle: TextStyle(color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600),
      filled: true,
      fillColor: isDarkMode ? Colors.grey.shade900.withOpacity(0.5) : Colors.white,
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade400 : Colors.deepPurple),
      ),
    );
  }

  ButtonStyle _buildButtonStyle(bool isDarkMode) {
    return ElevatedButton.styleFrom(
      backgroundColor: isDarkMode ? Colors.grey.shade800.withOpacity(0.8) : Colors.white,
      foregroundColor: isDarkMode ? Colors.white : Colors.black,
      padding: const EdgeInsets.symmetric(vertical: 16),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
      ),
      elevation: isDarkMode ? 2 : 4,
      shadowColor: Colors.black.withOpacity(0.2),
      textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
    );
  }

  Widget _buildRememberMeRow(bool isDarkMode) {
    final textColor = isDarkMode ? Colors.grey.shade400 : Colors.grey.shade700;
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Row(
          children: [
            SizedBox(
              width: 24,
              height: 24,
              child: Checkbox(
                value: _rememberMe,
                onChanged: (value) {
                  setState(() {
                    _rememberMe = value ?? false;
                  });
                },
                side: BorderSide(color: textColor),
                activeColor: isDarkMode ? Colors.grey.shade700 : Colors.deepPurple.shade100,
                checkColor: isDarkMode ? Colors.white : Colors.deepPurple,
              ),
            ),
            const SizedBox(width: 8),
            Text('Remember me', style: TextStyle(color: textColor)),
          ],
        ),
        TextButton(
          onPressed: () {
            Navigator.pushNamed(context, '/forgot_password');
          },
          child: Text('Forgot Password', style: TextStyle(color: textColor)),
        ),
      ],
    );
  }

  Widget _buildDividerWithText(bool isDarkMode) {
    return Row(
      children: [
        Expanded(
          child: Divider(
            color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300,
            thickness: 1,
          ),
        ),
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Text(
            "Don't have an account?",
            style: TextStyle(color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade700),
          ),
        ),
        Expanded(
          child: Divider(
            color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300,
            thickness: 1,
          ),
        ),
      ],
    );
  }
}


// ===== lib/features/authentication/screens/signup_screen.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';
import 'package:AutoAir/themes/custom_colors.dart';

class SignUpScreen extends StatefulWidget {
  const SignUpScreen({Key? key}) : super(key: key);

  @override
  _SignUpScreenState createState() => _SignUpScreenState();
}

class _SignUpScreenState extends State<SignUpScreen> {
  final _formKey = GlobalKey<FormState>();
  final _firstNameController = TextEditingController();
  final _lastNameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  final _apiService = ApiService();

  bool _isPasswordObscured = true;
  bool _isConfirmPasswordObscured = true;
  bool _isLoading = false;

  @override
  void dispose() {
    _firstNameController.dispose();
    _lastNameController.dispose();
    _emailController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  Future<void> _register() async {
    if (!(_formKey.currentState?.validate() ?? false)) {
      return;
    }
    setState(() {
      _isLoading = true;
    });
    try {
      await _apiService.register(
        firstName: _firstNameController.text.trim(),
        lastName: _lastNameController.text.trim(),
        email: _emailController.text.trim(),
        password: _passwordController.text,
        passwordConfirmation: _confirmPasswordController.text,
      );
      if (!mounted) return;
      Navigator.of(context).pushNamedAndRemoveUntil('/device_list', (route) => false);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.toString()), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;
    final customColors = theme.extension<CustomColors>()!;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 32.0),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: <Widget>[
                    Image.asset(AppAssets.logo, height: 80),
                    const SizedBox(height: 16),
                    Text(
                      'AutoAir',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineLarge?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 48),
                    Text(
                      'Sign Up Account',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineSmall?.copyWith(
                        color: isDarkMode ? Colors.white : Colors.black87,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: 32),
                    Row(
                      children: [
                        Expanded(
                          child: TextFormField(
                            controller: _firstNameController,
                            style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                            decoration: _input('First Name', isDarkMode),
                            textCapitalization: TextCapitalization.words,
                            validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: TextFormField(
                            controller: _lastNameController,
                            style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                            decoration: _input('Last Name', isDarkMode),
                            textCapitalization: TextCapitalization.words,
                            validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 24),
                    TextFormField(
                      controller: _emailController,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _input('Email', isDarkMode),
                      keyboardType: TextInputType.emailAddress,
                      validator: (v) {
                        if (v == null || v.isEmpty) return 'Enter your email';
                        if (!v.contains('@')) return 'Enter a valid email';
                        return null;
                      },
                    ),
                    const SizedBox(height: 24),
                    TextFormField(
                      controller: _passwordController,
                      obscureText: _isPasswordObscured,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _input('Password', isDarkMode).copyWith(
                        suffixIcon: IconButton(
                          icon: Icon(
                            _isPasswordObscured ? Icons.visibility_off_outlined : Icons.visibility_outlined,
                            color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600,
                          ),
                          onPressed: () => setState(() => _isPasswordObscured = !_isPasswordObscured),
                        ),
                      ),
                      validator: (v) {
                        if (v == null || v.isEmpty) return 'Enter a password';
                        if (v.length < 6) return 'Minimum 6 characters';
                        return null;
                      },
                    ),
                    const SizedBox(height: 24),
                    TextFormField(
                      controller: _confirmPasswordController,
                      obscureText: _isConfirmPasswordObscured,
                      style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
                      decoration: _input('Confirm Password', isDarkMode).copyWith(
                        suffixIcon: IconButton(
                          icon: Icon(
                            _isConfirmPasswordObscured ? Icons.visibility_off_outlined : Icons.visibility_outlined,
                            color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600,
                          ),
                          onPressed: () => setState(() => _isConfirmPasswordObscured = !_isConfirmPasswordObscured),
                        ),
                      ),
                      validator: (v) {
                        if (v == null || v.isEmpty) return 'Re-enter password';
                        if (v != _passwordController.text) return 'Passwords do not match';
                        return null;
                      },
                    ),
                    const SizedBox(height: 32),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: customColors.primaryAction,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                      ),
                      onPressed: _isLoading ? null : _register,
                      child: _isLoading
                          ? const SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2),
                      )
                          : const Text('Sign up'),
                    ),
                    const SizedBox(height: 32),
                    Row(
                      children: [
                        Expanded(
                          child: Divider(
                            color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300,
                            thickness: 1,
                          ),
                        ),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Text(
                            "Already have an account?",
                            style: TextStyle(color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade700),
                          ),
                        ),
                        Expanded(
                          child: Divider(
                            color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300,
                            thickness: 1,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: isDarkMode ? Colors.grey.shade800.withOpacity(0.8) : Colors.white,
                        foregroundColor: isDarkMode ? Colors.white : Colors.black,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                          side: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
                        ),
                        elevation: isDarkMode ? 2 : 4,
                        shadowColor: Colors.black.withOpacity(0.2),
                        textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                      ),
                      onPressed: () {
                        Navigator.of(context).pushNamedAndRemoveUntil('/login', (route) => false);
                      },
                      child: const Text('Log in'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  InputDecoration _input(String label, bool isDarkMode) {
    return InputDecoration(
      labelText: label,
      labelStyle: TextStyle(color: isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600),
      filled: true,
      fillColor: isDarkMode ? Colors.grey.shade900.withOpacity(0.5) : Colors.white,
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade400 : Colors.deepPurple),
      ),
      errorStyle: const TextStyle(color: Colors.redAccent),
    );
  }
}


// ===== lib/features/dashboard/models/hourly_record_model.dart =====

class HourlyRecord {
  final DateTime timestamp;
  final double current1;
  final double current2;
  final double current3;
  final double current4;

  HourlyRecord({
    required this.timestamp,
    required this.current1,
    required this.current2,
    required this.current3,
    required this.current4,
  });

  double get total => current1 + current2 + current3 + current4;

  double getValue(int index) {
    switch (index) {
      case 0:
        return current1;
      case 1:
        return current2;
      case 2:
        return current3;
      case 3:
        return current4;
      default:
        return 0.0;
    }
  }
}

// ===== lib/features/dashboard/models/relay_model.dart =====

class Relay {
  final int id;
  final String name;
  final double amperage;
  bool isOn;

  Relay({
    required this.id,
    required this.name,
    required this.amperage,
    required this.isOn,
  });
}

// ===== lib/features/dashboard/models/schedule_model.dart =====

class RelaySchedule {
  final int id;
  final String title;
  final String timeRange;
  final String days;
  bool isActive;

  RelaySchedule({
    required this.id,
    required this.title,
    required this.timeRange,
    required this.days,
    required this.isActive,
  });
}

// ===== lib/features/dashboard/screens/dashboard_screen.dart =====

import 'dart:async';
import 'dart:math';
import 'dart:ui' as ui;

import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:wifi_iot/wifi_iot.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';

import 'package:AutoAir/features/dashboard/models/relay_model.dart';
import 'package:AutoAir/providers/dashboard_provider.dart';
import 'package:AutoAir/themes/custom_colors.dart';
import 'package:AutoAir/widgets/app_background.dart';
import 'package:AutoAir/features/dashboard/widgets/fan_control_settings_tab.dart';

class DashboardScreen extends StatefulWidget {
  const DashboardScreen({Key? key}) : super(key: key);

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> {
  int _selectedActionIndex = 0;
  late PageController _pageController;
  int _currentPage = 0;

  @override
  void initState() {
    super.initState();
    _pageController = PageController();
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: _buildCustomAppBar(context),
        body: SafeArea(
          bottom: true,
          child: Consumer<DashboardProvider>(
            builder: (context, provider, _) {
              if (provider.isLoading) {
                return const Center(child: CircularProgressIndicator());
              }
              if (provider.error != null) {
                return Center(
                  child: Padding(
                    padding: const EdgeInsets.all(20.0),
                    child: Text(
                      provider.error!,
                      style: const TextStyle(color: Colors.red),
                      textAlign: TextAlign.center,
                    ),
                  ),
                );
              }
              return _buildDashboardContent(context, provider);
            },
          ),
        ),
      ),
    );
  }

  PreferredSizeWidget _buildCustomAppBar(BuildContext context) {
    return AppBar(
      backgroundColor: Colors.transparent,
      elevation: 0,
      automaticallyImplyLeading: false,
      title: const _StatusHeader(),
      actions: const [
        Padding(
          padding: EdgeInsets.only(right: 10),
          child: CircleAvatar(
            radius: 16,
            backgroundColor: Colors.white24,
            child: Icon(Icons.person, size: 18, color: Colors.white),
          ),
        ),
      ],
    );
  }

  Widget _buildDashboardContent(BuildContext context, DashboardProvider provider) {
    return SingleChildScrollView(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        child: Column(
          children: [
            DashboardCard(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    const SizedBox(height: 24),
                    Text(
                      'Power Monitor',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 24),
                    _buildSlidableGauges(provider),
                    const SizedBox(height: 32),
                    _buildStatusInfo(provider),
                    const SizedBox(height: 24),
                    _buildActionButtons(),
                    const SizedBox(height: 24),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 24),
            _buildContentSection(provider),
            const SizedBox(height: 24),
          ],
        ),
      ),
    );
  }

  Widget _buildSlidableGauges(DashboardProvider provider) {
    final List<Map<String, dynamic>> gauges = [
      {
        'label': 'Temperature',
        'metric': _Metric.temperature,
        'color': const Color(0xFF22D3EE),
        'unit': '',
      },
      {
        'label': 'Humidity',
        'metric': _Metric.humidity,
        'color': const Color(0xFF22C55E),
        'unit': '%',
      },
      {
        'label': 'Heat Index',
        'metric': _Metric.heatIndex,
        'color': const Color(0xFFFB923C),
        'unit': '',
      },
    ];

    return Column(
      children: [
        SizedBox(
          height: 250,
          child: PageView.builder(
            controller: _pageController,
            itemCount: gauges.length,
            onPageChanged: (index) {
              setState(() {
                _currentPage = index;
              });
            },
            itemBuilder: (context, index) {
              final gauge = gauges[index];
              return _MonitorGauge(
                size: 250,
                label: gauge['label'],
                metric: gauge['metric'],
                color: gauge['color'],
                unit: gauge['unit'],
              );
            },
          ),
        ),
        const SizedBox(height: 16),
        _buildDotIndicator(gauges.length, _currentPage),
      ],
    );
  }

  Widget _buildDotIndicator(int pageCount, int currentPage) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(pageCount, (index) {
        return AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          margin: const EdgeInsets.symmetric(horizontal: 4.0),
          height: 8.0,
          width: 8.0,
          decoration: BoxDecoration(
            color: currentPage == index ? Colors.white : Colors.grey.shade700,
            shape: BoxShape.circle,
          ),
        );
      }),
    );
  }

  Widget _buildStatusInfo(DashboardProvider provider) {
    return Row(
      children: [
        Expanded(
          child: _InfoChip(icon: Icons.sync, label: 'Mode: ${provider.mode}'),
        ),
        Expanded(
          child: _InfoChip(
            icon: Icons.ssid_chart,
            label: 'Total kWh: ${provider.totalKwh.toStringAsFixed(0)} kWh',
          ),
        ),
        Expanded(
          child: _InfoChip(
            icon: Icons.close,
            label: 'Status: ${provider.isPowerOn ? "On" : "Off"}',
          ),
        ),
      ],
    );
  }

  Widget _buildActionButtons() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: [
        _buildActionButton(icon: FontAwesomeIcons.clock, index: 0),
        _buildActionButton(icon: FontAwesomeIcons.fan, index: 1),
        _buildActionButton(icon: FontAwesomeIcons.boltLightning, index: 2),
        _buildActionButton(icon: FontAwesomeIcons.sliders, index: 3),
        _buildActionButton(icon: FontAwesomeIcons.gear, index: 4),
      ],
    );
  }

  Widget _buildActionButton({required IconData icon, required int index}) {
    final isSelected = _selectedActionIndex == index;
    final theme = Theme.of(context);

    return GestureDetector(
      onTap: () {
        if (index == 2) {
          Navigator.pushNamed(context, '/hourly_records');
        } else if (index == 4) {
          Navigator.pushNamed(context, '/firmware_update');
        } else {
          setState(() => _selectedActionIndex = index);
        }
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        width: 55,
        height: 55,
        decoration: BoxDecoration(
          color: isSelected ? theme.colorScheme.primary : const Color(0xFF2C2C2E),
          borderRadius: BorderRadius.circular(22),
        ),
        child: Center(
          child: Container(
            width: 35,
            height: 35,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              border: Border.all(color: Colors.white, width: 2.0),
            ),
            child: Center(
              child: FaIcon(
                icon,
                color: Colors.white,
                size: 18,
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildContentSection(DashboardProvider provider) {
    return AnimatedSwitcher(
      duration: const Duration(milliseconds: 300),
      child: _getSelectedSection(provider),
    );
  }

  Widget _getSelectedSection(DashboardProvider provider) {
    switch (_selectedActionIndex) {
      case 0:
        return _buildRelaySettings(provider);
      case 1:
        return const FanControlSettingsTab();
      default:
        return Container(
          key: const ValueKey('empty'),
        );
    }
  }

  Widget _buildRelaySettings(DashboardProvider provider) {
    final theme = Theme.of(context);
    return DashboardCard(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            const SizedBox(height: 24),
            Text(
              'Relay Settings',
              textAlign: TextAlign.center,
              style: theme.textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.w800,
                letterSpacing: 0.2,
              ),
            ),
            const SizedBox(height: 16),
            if (provider.relays.isEmpty)
              const Padding(
                padding: EdgeInsets.fromLTRB(0, 24, 0, 40),
                child: Center(child: Text('No relays found for this device.')),
              )
            else
              ...provider.relays.map((relay) {
                return Padding(
                  padding: const EdgeInsets.only(bottom: 14.0),
                  child: _RelayCard(
                    relay: relay,
                    onToggle: (value) => provider.toggleRelay(relay.id, value),
                  ),
                );
              }).toList(),
            const SizedBox(height: 10),
          ],
        ),
      ),
    );
  }
}

class DashboardCard extends StatelessWidget {
  const DashboardCard({Key? key, required this.child}) : super(key: key);
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(20),
      child: BackdropFilter(
        filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8),
        child: Container(
          decoration: BoxDecoration(
            color: const Color(0xFF141416).withOpacity(0.18),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(color: Colors.white.withOpacity(0.08)),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 16,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: child,
        ),
      ),
    );
  }
}

class _StatusHeader extends StatefulWidget {
  const _StatusHeader();

  @override
  State<_StatusHeader> createState() => _StatusHeaderState();
}

class _StatusHeaderState extends State<_StatusHeader> {
  late Timer _clock;
  DateTime _now = DateTime.now();

  final _conn = Connectivity();
  StreamSubscription<List<ConnectivityResult>>? _connSub;

  int _signalBars = 0;
  bool _onWifi = false;

  static const double _tilt = -pi / 10;

  @override
  void initState() {
    super.initState();
    _clock = Timer.periodic(const Duration(seconds: 1), (_) {
      if (mounted) setState(() => _now = DateTime.now());
    });
    _connSub = _conn.onConnectivityChanged.listen((_) => _refreshSignal());
    _refreshSignal();
  }

  Future<void> _refreshSignal() async {
    try {
      final result = await _conn.checkConnectivity();
      _onWifi = result.contains(ConnectivityResult.wifi);
      int bars = 0;
      if (_onWifi) {
        final int? rssi = await WiFiForIoTPlugin.getCurrentSignalStrength();
        if (rssi != null) {
          final int v = (rssi > 0) ? -rssi : rssi;
          if (v >= -55) {
            bars = 4;
          } else if (v >= -67) {
            bars = 3;
          } else if (v >= -75) {
            bars = 2;
          } else if (v >= -90) {
            bars = 1;
          } else {
            bars = 1;
          }
        } else {
          bars = 2;
        }
      } else {
        bars = 0;
      }
      if (mounted) setState(() => _signalBars = bars);
    } catch (_) {
      if (mounted) setState(() => _signalBars = _onWifi ? 2 : 0);
    }
  }

  @override
  void dispose() {
    _clock.cancel();
    _connSub?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final timeStr = _formatTime(_now);
    final dateStr = _formatDate(_now);

    return Row(
      children: [
        Transform(
          alignment: Alignment.center,
          transform: Matrix4.identity()..scale(-1.0, 1.0),
          child: Transform.rotate(
            angle: _tilt,
            child: Padding(
              padding: const EdgeInsets.only(top: 2),
              child: _WifiRssIcon(
                size: 24,
                color: Colors.white70,
                strokeWidth: 5.5,
                gap: 2.0,
                signalBars: _signalBars,
              ),
            ),
          ),
        ),
        const SizedBox(width: 10),
        Expanded(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                timeStr,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: Theme.of(context)
                    .textTheme
                    .labelLarge
                    ?.copyWith(height: 1.0, color: Colors.white),
              ),
              Text(
                dateStr,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: Theme.of(context)
                    .textTheme
                    .bodySmall
                    ?.copyWith(height: 1.0, color: Colors.white70),
              ),
            ],
          ),
        ),
      ],
    );
  }

  String _formatTime(DateTime dt) {
    final h = dt.hour % 12 == 0 ? 12 : dt.hour % 12;
    final m = dt.minute.toString().padLeft(2, '0');
    final ampm = dt.hour >= 12 ? 'PM' : 'AM';
    return '$h:$m $ampm';
  }

  String _formatDate(DateTime dt) {
    const months = [
      'Jan',
      'Feb',
      'Mar',
      'Apr',
      'May',
      'Jun',
      'Jul',
      'Aug',
      'Sep',
      'Oct',
      'Nov',
      'Dec'
    ];
    final mon = months[dt.month - 1];
    final day = dt.day.toString().padLeft(2, '0');
    return '$mon $day, ${dt.year}';
  }
}

class _WifiRssIcon extends StatelessWidget {
  const _WifiRssIcon({
    Key? key,
    this.size = 48,
    this.color = Colors.white70,
    this.strokeWidth = 7.0,
    this.gap = 3.0,
    this.signalBars = 0,
  }) : super(key: key);

  final double size;
  final Color color;
  final double strokeWidth;
  final double gap;
  final int signalBars;

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      size: Size.square(size),
      painter: _WifiRssPainter(
        color: color,
        strokeWidth: strokeWidth,
        gap: gap,
        signalBars: signalBars.clamp(0, 4),
      ),
    );
  }
}

class _WifiRssPainter extends CustomPainter {
  _WifiRssPainter({
    required this.color,
    required this.strokeWidth,
    required this.gap,
    required this.signalBars,
  });

  final Color color;
  final double strokeWidth;
  final double gap;
  final int signalBars;

  @override
  void paint(Canvas canvas, Size size) {
    final double s = min(size.width, size.height);
    final Offset base = Offset(s * 0.18, s * 0.78);
    final double dotR = s * 0.11;

    final activePaint = Paint()
      ..style = PaintingStyle.fill
      ..color = color
      ..isAntiAlias = true;

    final inactivePaint = Paint()
      ..style = PaintingStyle.fill
      ..color = color.withOpacity(0.3)
      ..isAntiAlias = true;

    final double r1 = s * 0.34;
    final double r2 = r1 + gap + strokeWidth;
    final double r3 = r2 + gap + strokeWidth;

    void band(double rOuter, Paint paint) {
      final double rInner = max(0, rOuter - strokeWidth);
      final Rect outer = Rect.fromCircle(center: base, radius: rOuter);
      final Rect inner = Rect.fromCircle(center: base, radius: rInner);
      final Path p = Path()
        ..arcTo(outer, -pi / 2, pi / 2, false)
        ..arcTo(inner, 0, -pi / 2, false)
        ..close();
      canvas.drawPath(p, paint);
    }

    canvas.drawCircle(base, dotR, signalBars >= 1 ? activePaint : inactivePaint);
    band(r1, signalBars >= 2 ? activePaint : inactivePaint);
    band(r2, signalBars >= 3 ? activePaint : inactivePaint);
    band(r3, signalBars >= 4 ? activePaint : inactivePaint);
  }

  @override
  bool shouldRepaint(covariant _WifiRssPainter oldDelegate) {
    return oldDelegate.color != color ||
        oldDelegate.strokeWidth != strokeWidth ||
        oldDelegate.gap != gap ||
        oldDelegate.signalBars != signalBars;
  }
}

enum _Metric { temperature, humidity, heatIndex }

class _MonitorGauge extends StatefulWidget {
  const _MonitorGauge({
    required this.label,
    required this.color,
    required this.metric,
    required this.size,
    required this.unit,
  });

  final String label;
  final Color color;
  final _Metric metric;
  final double size;
  final String unit;

  @override
  State<_MonitorGauge> createState() => _MonitorGaugeState();
}

class _MonitorGaugeState extends State<_MonitorGauge> {
  String _formatMetric(DashboardProvider p) {
    switch (widget.metric) {
      case _Metric.temperature:
        final v = p.temperature;
        return v == null ? '' : v.toStringAsFixed(0);
      case _Metric.humidity:
        final v = p.humidity;
        return v == null ? '' : v.toStringAsFixed(0);
      case _Metric.heatIndex:
        final v = p.heatIndex;
        return v == null ? '' : v.toStringAsFixed(0);
    }
  }

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(
      child: SizedBox(
        width: widget.size,
        height: widget.size,
        child: CustomPaint(
          painter: _AnimatedDottedCirclePainter(
            color: widget.color,
            rotationAngle: 0.0,
          ),
          child: Center(
            child: Consumer<DashboardProvider>(
              builder: (_, p, __) {
                final valueStyle = TextStyle(
                  fontSize: widget.size * 0.20,
                  fontWeight: FontWeight.bold,
                  color: widget.color,
                  height: 1.0,
                );
                final unitStyle = TextStyle(
                  fontSize: widget.size * 0.12,
                  fontWeight: FontWeight.bold,
                  color: widget.color,
                  fontFeatures: const [FontFeature.superscripts()],
                );
                final labelStyle = TextStyle(
                  fontSize: widget.size * 0.07,
                  fontWeight: FontWeight.w400,
                  color: widget.color.withOpacity(0.8),
                  height: 1.5,
                );

                return RichText(
                  textAlign: TextAlign.center,
                  text: TextSpan(
                    style: DefaultTextStyle.of(context).style,
                    children: <TextSpan>[
                      TextSpan(
                        text: _formatMetric(p),
                        style: valueStyle,
                      ),
                      TextSpan(
                        text: widget.unit,
                        style: unitStyle,
                      ),
                      TextSpan(
                        text: '\n${widget.label}',
                        style: labelStyle,
                      ),
                    ],
                  ),
                );
              },
            ),
          ),
        ),
      ),
    );
  }
}

class _AnimatedDottedCirclePainter extends CustomPainter {
  _AnimatedDottedCirclePainter({
    required this.color,
    required this.rotationAngle,
  });

  final Color color;
  final double rotationAngle;

  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = min(size.width, size.height) / 2;
    final paint = Paint()..isAntiAlias = true;
    const brightestAngle = -pi / 2.5;

    final rings = [
      {'radiusFactor': 0.60, 'dotSizeFactor': 0.012, 'dotCount': 40, 'baseOpacity': 1.0},
      {'radiusFactor': 0.72, 'dotSizeFactor': 0.013, 'dotCount': 45, 'baseOpacity': 0.7},
      {'radiusFactor': 0.84, 'dotSizeFactor': 0.014, 'dotCount': 50, 'baseOpacity': 0.5},
      {'radiusFactor': 0.96, 'dotSizeFactor': 0.015, 'dotCount': 55, 'baseOpacity': 0.3},
    ];

    for (final ring in rings) {
      final ringRadius = radius * (ring['radiusFactor'] as double);
      final dotRadius = size.width * (ring['dotSizeFactor'] as double);
      final numberOfDots = ring['dotCount'] as int;
      final baseOpacity = ring['baseOpacity'] as double;

      for (int i = 0; i < numberOfDots; i++) {
        final double theta = (i / numberOfDots) * 2 * pi + rotationAngle;

        final double cosDiff = cos(theta - brightestAngle);
        const double minAngularOpacity = 0.8;
        const double maxAngularOpacity = 1.0;
        final double normalized = (cosDiff + 1) / 2;
        final double angularOpacity = minAngularOpacity + normalized * (maxAngularOpacity - minAngularOpacity);

        final finalOpacity = baseOpacity * angularOpacity;
        paint.color = color.withOpacity(finalOpacity);

        final p = Offset(
          center.dx + ringRadius * cos(theta),
          center.dy + ringRadius * sin(theta),
        );
        canvas.drawCircle(p, dotRadius, paint);
      }
    }
  }

  @override
  bool shouldRepaint(covariant _AnimatedDottedCirclePainter oldDelegate) {
    return oldDelegate.color != color || oldDelegate.rotationAngle != rotationAngle;
  }
}

class _InfoChip extends StatelessWidget {
  const _InfoChip({required this.icon, required this.label});

  final IconData icon;
  final String label;

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        CircleAvatar(
          radius: 11,
          backgroundColor: Colors.white.withOpacity(0.9),
          child: Icon(icon, size: 14, color: Colors.black87),
        ),
        const SizedBox(width: 6),
        Flexible(
          child: Text(
            label,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(color: Colors.white70),
            overflow: TextOverflow.ellipsis,
            maxLines: 1,
          ),
        ),
      ],
    );
  }
}

class _RelayCard extends StatefulWidget {
  const _RelayCard({
    required this.relay,
    required this.onToggle,
  });

  final Relay relay;
  final ValueChanged<bool> onToggle;

  @override
  State<_RelayCard> createState() => _RelayCardState();
}

class _RelayCardState extends State<_RelayCard> {
  bool _isAutoMode = false;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final custom = theme.extension<CustomColors>()!;
    final bool isOn = widget.relay.isOn;
    final double currentA = widget.relay.amperage;

    return AnimatedContainer(
      duration: const Duration(milliseconds: 220),
      curve: Curves.easeOut,
      decoration: BoxDecoration(
        color: const Color(0xFF0F0F10),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(
          color: isOn ? custom.successBorder! : Colors.white.withOpacity(0.06),
        ),
      ),
      padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Row(
            children: [
              Text(
                widget.relay.name,
                style: theme.textTheme.titleMedium?.copyWith(
                  color: Colors.white,
                  fontWeight: FontWeight.w700,
                ),
              ),
              const Spacer(),
              if (_isAutoMode)
                AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  width: 16,
                  height: 16,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: isOn ? custom.success : Colors.grey.shade800,
                  ),
                )
              else
                Switch(
                  value: isOn,
                  onChanged: widget.onToggle,
                  thumbColor: MaterialStateProperty.resolveWith((_) => isOn ? Colors.white : Colors.white70),
                  trackColor: MaterialStateProperty.resolveWith((_) => isOn ? custom.successTrack! : Colors.white10),
                  overlayColor: MaterialStateProperty.resolveWith(
                        (_) => isOn ? custom.success!.withOpacity(0.15) : Colors.white.withOpacity(0.05),
                  ),
                  materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                ),
            ],
          ),
          const SizedBox(height: 6),
          Container(
            alignment: Alignment.center,
            padding: const EdgeInsets.symmetric(vertical: 10),
            decoration: BoxDecoration(
              color: const Color(0xFF151517),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.white.withOpacity(0.04)),
            ),
            child: _SegmentDisplayText(
              text: '${currentA.toStringAsFixed(2)}  A',
            ),
          ),
          const SizedBox(height: 10),
          _DimButton(
            label: _isAutoMode ? 'Auto' : 'Manual',
            onPressed: () {
              setState(() {
                _isAutoMode = !_isAutoMode;
              });
            },
          ),
          const SizedBox(height: 8),
          _PrimaryButton(
            label: 'Configure Schedule',
            onPressed: () {
              Navigator.pushNamed(context, '/relay_schedule', arguments: widget.relay);
            },
            color: Theme.of(context).colorScheme.primary,
          ),
        ],
      ),
    );
  }
}

class _SegmentDisplayText extends StatelessWidget {
  const _SegmentDisplayText({required this.text});

  final String text;

  @override
  Widget build(BuildContext context) {
    return FittedBox(
      fit: BoxFit.scaleDown,
      child: Text(
        text,
        style: const TextStyle(
          fontFamily: 'DigitalNumbers',
          fontFeatures: [ui.FontFeature.tabularFigures()],
          fontSize: 34,
          letterSpacing: 2.0,
          color: Colors.white,
          height: 1.0,
        ),
      ),
    );
  }
}

class _DimButton extends StatelessWidget {
  const _DimButton({required this.label, required this.onPressed});

  final String label;
  final VoidCallback? onPressed;

  @override
  Widget build(BuildContext context) {
    const bg = Color(0xFF232325);
    return SizedBox(
      height: 40,
      child: TextButton(
        style: TextButton.styleFrom(
          backgroundColor: bg,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
            side: BorderSide(color: Colors.white.withOpacity(0.08)),
          ),
          textStyle: const TextStyle(fontSize: 14, fontWeight: FontWeight.w600),
        ),
        onPressed: onPressed,
        child: Text(label),
      ),
    );
  }
}

class _PrimaryButton extends StatelessWidget {
  const _PrimaryButton({
    required this.label,
    required this.onPressed,
    required this.color,
  });

  final String label;
  final VoidCallback onPressed;
  final Color color;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 40,
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          textStyle: const TextStyle(fontSize: 14, fontWeight: FontWeight.w700),
          padding: const EdgeInsets.symmetric(horizontal: 12),
          elevation: 0,
        ),
        onPressed: onPressed,
        child: Text(label),
      ),
    );
  }
}

// ===== lib/features/dashboard/screens/firmware_update_screen.dart =====

// ===== lib/features/dashboard/screens/firmware_update_screen.dart =====

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:dotted_border/dotted_border.dart';
import 'package:file_picker/file_picker.dart';
import 'package:AutoAir/widgets/app_background.dart';

class FirmwareUpdateScreen extends StatelessWidget {
  const FirmwareUpdateScreen({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return const AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: _FirmwareAppBar(),
        body: _FirmwareUpdateBody(),
      ),
    );
  }
}

class _FirmwareAppBar extends StatelessWidget implements PreferredSizeWidget {
  const _FirmwareAppBar();

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return AppBar(
      backgroundColor: Colors.transparent,
      elevation: 0,
      centerTitle: true,
      title: Text(
        'Firmware Update',
        style: TextStyle(color: isDark ? Colors.white : Colors.black),
      ),
      leading: IconButton(
        icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
        onPressed: () => Navigator.of(context).pop(),
      ),
    );
  }

  @override
  Size get preferredSize => const Size.fromHeight(kToolbarHeight);
}

class _FirmwareUpdateBody extends StatefulWidget {
  const _FirmwareUpdateBody();

  @override
  State<_FirmwareUpdateBody> createState() => _FirmwareUpdateBodyState();
}

class _FirmwareUpdateBodyState extends State<_FirmwareUpdateBody> {
  String? _fileName;
  bool _isUploading = false;
  double _uploadProgress = 0.0;
  Timer? _uploadTimer;

  @override
  void dispose() {
    _uploadTimer?.cancel();
    super.dispose();
  }

  Future<void> _pickFile() async {
    FilePickerResult? result = await FilePicker.platform.pickFiles(
      type: FileType.custom,
      allowedExtensions: ['bin'],
    );

    if (result != null) {
      setState(() {
        _fileName = result.files.single.name;
        _isUploading = false;
        _uploadProgress = 0.0;
      });
    }
  }

  void _startUpload() {
    setState(() {
      _isUploading = true;
      _uploadProgress = 0.0;
    });

    _uploadTimer = Timer.periodic(const Duration(milliseconds: 50), (timer) {
      setState(() {
        _uploadProgress += 0.01;
        if (_uploadProgress >= 1.0) {
          _uploadProgress = 1.0;
          _isUploading = false;
          timer.cancel();
        }
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          const _CurrentVersionCard(),
          const SizedBox(height: 24),
          const _WarningCard(),
          const SizedBox(height: 24),
          Text(
            'Select Firmware File (.bin)',
            style: theme.textTheme.titleLarge?.copyWith(fontWeight: FontWeight.bold),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          _FilePickerBox(
            fileName: _fileName,
            onChooseFile: _pickFile,
          ),
          const SizedBox(height: 8),
          const Text(
            'Note: Use the main .bin file (e.g., AAI_ESP32ino.bin), not the bootload or partition files.',
            style: TextStyle(color: Colors.white70, fontSize: 12),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 32),
          _buildUploadButton(),
          if (_isUploading)
            const Padding(
              padding: EdgeInsets.only(top: 8.0),
              child: Text(
                'Please do not close your browser window while uploading.',
                style: TextStyle(color: Colors.white70, fontSize: 12),
                textAlign: TextAlign.center,
              ),
            ),
          const SizedBox(height: 12),
          OutlinedButton(
            onPressed: _isUploading ? null : () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
        ],
      ),
    );
  }

  Widget _buildUploadButton() {
    final theme = Theme.of(context);
    final isComplete = _uploadProgress >= 1.0;
    final isDisabled = _fileName == null || isComplete;

    String buttonText;
    if (isComplete) {
      buttonText = 'Uploaded (100%)';
    } else if (_isUploading) {
      buttonText = 'Uploading Firmware... (${(_uploadProgress * 100).toInt()}%)';
    } else {
      buttonText = 'Upload Firmware';
    }

    return ElevatedButton(
      onPressed: isDisabled ? null : _startUpload,
      style: ElevatedButton.styleFrom(
        padding: EdgeInsets.zero,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ).copyWith(
        backgroundColor: MaterialStateProperty.resolveWith<Color?>(
              (states) {
            if (states.contains(MaterialState.disabled)) {
              return isComplete ? theme.colorScheme.primary : Colors.grey.shade800;
            }
            return theme.colorScheme.primary;
          },
        ),
      ),
      child: Stack(
        alignment: Alignment.center,
        children: [
          if (_isUploading)
            ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: LinearProgressIndicator(
                value: _uploadProgress,
                backgroundColor: theme.colorScheme.primary.withOpacity(0.3),
                valueColor: AlwaysStoppedAnimation<Color>(theme.colorScheme.primary),
              ),
            ),
          Padding(
            padding: const EdgeInsets.symmetric(vertical: 14),
            child: Text(buttonText),
          ),
        ],
      ),
    );
  }
}

class _CurrentVersionCard extends StatelessWidget {
  const _CurrentVersionCard();
  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1C1C1E).withOpacity(0.6),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: [
          Text(
            'Current Version',
            style: theme.textTheme.titleLarge?.copyWith(fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 12),
          _buildInfoRow('Version:', '20.0.1 - Enhanced'),
          _buildInfoRow('Build:', 'Build-008'),
          _buildInfoRow('Build Date:', 'Jul 31 2025'),
        ],
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.white70)),
          Text(value, style: const TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}

class _WarningCard extends StatelessWidget {
  const _WarningCard();
  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.amber.withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.amber.withOpacity(0.3)),
      ),
      child: const Row(
        children: [
          Icon(Icons.warning_amber_rounded, color: Colors.amber),
          SizedBox(width: 12),
          Expanded(
            child: Text(
              'Warning: Do not power off the device during the update process. The device will restart automatically after a successful update.',
              style: TextStyle(color: Colors.white, fontSize: 12),
            ),
          ),
        ],
      ),
    );
  }
}

class _FilePickerBox extends StatelessWidget {
  const _FilePickerBox({this.fileName, required this.onChooseFile});
  final String? fileName;
  final VoidCallback onChooseFile;

  @override
  Widget build(BuildContext context) {
    return DottedBorder(
      color: Colors.white38,
      strokeWidth: 2,
      dashPattern: const <double>[8, 6],
      borderType: BorderType.RRect,
      radius: const Radius.circular(12),
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 24, horizontal: 16),
        child: Center(
          child: Column(
            children: [
              if (fileName == null) ...[
                const Icon(Icons.upload_file, size: 40, color: Colors.white70),
                const SizedBox(height: 8),
                const Text(
                  'Choose a file or drag and drop it here',
                  style: TextStyle(color: Colors.white70),
                  textAlign: TextAlign.center,
                ),
              ] else ...[
                const Icon(Icons.insert_drive_file, size: 40, color: Colors.white70),
                const SizedBox(height: 8),
                Text(
                  fileName!,
                  style: const TextStyle(fontWeight: FontWeight.bold),
                  textAlign: TextAlign.center,
                ),
              ],
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: onChooseFile,
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.grey.shade800,
                  foregroundColor: Colors.white,
                ),
                child: const Text('Choose File'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ===== lib/features/dashboard/screens/hourly_records_screen.dart =====

import 'dart:math';
import 'dart:ui';
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:AutoAir/features/dashboard/models/hourly_record_model.dart';
import 'package:AutoAir/widgets/app_background.dart';

class HourlyRecordsScreen extends StatelessWidget {
  const HourlyRecordsScreen({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          centerTitle: true,
          title: Text(
            'Detailed Hourly Records',
            style: TextStyle(color: isDark ? Colors.white : Colors.black),
          ),
          leading: IconButton(
            icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ),
        body: const _HourlyRecordsBody(),
      ),
    );
  }
}

class _HourlyRecordsBody extends StatefulWidget {
  const _HourlyRecordsBody();

  @override
  State<_HourlyRecordsBody> createState() => _HourlyRecordsBodyState();
}

class _HourlyRecordsBodyState extends State<_HourlyRecordsBody> {
  late List<HourlyRecord> _records;
  bool _isBreakdown = true;
  int _selectedTableCurrent = 0;

  final List<Color> _lineColors = const [
    Color(0xFFFF5A5F),
    Color(0xFF22D3EE),
    Color(0xFF86EFAC),
    Color(0xFFF59E0B),
  ];

  @override
  void initState() {
    super.initState();
    final now = DateTime.now();
    final random = Random();
    _records = List.generate(
      24,
          (index) => HourlyRecord(
        timestamp: now.subtract(Duration(hours: 24 - index)),
        current1: 1500 + random.nextDouble() * 500,
        current2: 1200 + random.nextDouble() * 600,
        current3: 1800 + random.nextDouble() * 400,
        current4: 1000 + random.nextDouble() * 700,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final chartHeight = min(320.0, MediaQuery.of(context).size.height * 0.34);

    return ListView(
      padding: const EdgeInsets.fromLTRB(16, 8, 16, 24),
      children: [
        _GlassContainer(
          child: Padding(
            padding: const EdgeInsets.fromLTRB(16, 16, 16, 20),
            child: Column(
              children: [
                _GraphSwitch(
                  isBreakdown: _isBreakdown,
                  onToggle: (val) => setState(() => _isBreakdown = val),
                ),
                const SizedBox(height: 16),
                RepaintBoundary(
                  child: SizedBox(
                    height: chartHeight,
                    child: AnimatedSwitcher(
                      duration: const Duration(milliseconds: 350),
                      child: _buildChart(theme),
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                AnimatedSwitcher(
                  duration: const Duration(milliseconds: 250),
                  child: _isBreakdown
                      ? _ChartLegend(colors: _lineColors)
                      : const SizedBox.shrink(),
                ),
              ],
            ),
          ),
        ),
        const SizedBox(height: 24),
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Export to CSV coming soon')),
              );
            },
            style: ElevatedButton.styleFrom(
              padding: const EdgeInsets.symmetric(vertical: 14),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
            child: const Text('Download as Excel (CSV)'),
          ),
        ),
        const SizedBox(height: 24),
        _buildDataTable(context),
      ],
    );
  }

  Widget _buildChart(ThemeData theme) {
    if (_records.isEmpty) {
      return const Center(
        child: Text('No data', style: TextStyle(color: Colors.white70)),
      );
    }

    final lines = _isBreakdown
        ? [
      _buildLine(_records.map((r) => r.current1).toList(), _lineColors[0]),
      _buildLine(_records.map((r) => r.current2).toList(), _lineColors[1]),
      _buildLine(_records.map((r) => r.current3).toList(), _lineColors[2]),
      _buildLine(_records.map((r) => r.current4).toList(), _lineColors[3]),
    ]
        : [
      _buildLine(_records.map((r) => r.total).toList(), theme.colorScheme.primary),
    ];

    final allY = lines.expand((l) => l.spots.map((s) => s.y)).toList();
    final bounds = _niceBounds(allY);

    return LineChart(
      LineChartData(
        minY: bounds.$1,
        maxY: bounds.$2,
        lineBarsData: lines,
        gridData: FlGridData(
          show: true,
          drawVerticalLine: true,
          horizontalInterval: (bounds.$2 - bounds.$1) / 4,
          getDrawingHorizontalLine: (_) => const FlLine(color: Colors.white10, strokeWidth: 1),
          getDrawingVerticalLine: (_) => const FlLine(color: Colors.white10, strokeWidth: 1),
        ),
        titlesData: _chartTitles(bounds),
        borderData: FlBorderData(show: true, border: Border.all(color: Colors.white24)),
        lineTouchData: LineTouchData(
          enabled: true,
          handleBuiltInTouches: true,
          touchTooltipData: LineTouchTooltipData(
            tooltipPadding: const EdgeInsets.all(8),
            tooltipMargin: 12,
            fitInsideHorizontally: true,
            fitInsideVertically: true,
            getTooltipItems: (spots) => spots.map((ts) {
              final i = ts.x.toInt().clamp(0, _records.length - 1);
              return LineTooltipItem(
                  '${(ts.y / 1000).toStringAsFixed(2)}k kWh\n',
                  TextStyle(
                    color: ts.bar.color ?? Colors.white,
                    fontWeight: FontWeight.w700,
                    fontSize: 14,
                  ),
                  children: [
                    TextSpan(
                      text: DateFormat('yyyy-MM-dd HH:mm').format(_records[i].timestamp),
                      style: const TextStyle(
                        color: Colors.white70,
                        fontWeight: FontWeight.normal,
                        fontSize: 12,
                      ),
                    ),
                  ]
              );
            }).toList(),
          ),
        ),
      ),
      duration: const Duration(milliseconds: 350),
    );
  }

  LineChartBarData _buildLine(List<double> data, Color color) {
    return LineChartBarData(
      spots: List.generate(data.length, (i) => FlSpot(i.toDouble(), data[i])),
      isCurved: true,
      curveSmoothness: 0.15,
      color: color,
      barWidth: 2.5,
      isStrokeCapRound: true,
      dotData: const FlDotData(show: false),
      belowBarData: BarAreaData(
        show: true,
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [color.withOpacity(0.25), color.withOpacity(0.0)],
        ),
      ),
    );
  }

  FlTitlesData _chartTitles((double, double) yBounds) {
    return FlTitlesData(
      leftTitles: AxisTitles(
        axisNameSize: 22,
        axisNameWidget: const Text('Current (kWh)', style: TextStyle(color: Colors.white70, fontSize: 12)),
        sideTitles: SideTitles(
          showTitles: true,
          reservedSize: 44,
          interval: (yBounds.$2 - yBounds.$1) / 4,
          getTitlesWidget: (value, meta) {
            if (value > meta.max || value < meta.min) return const SizedBox.shrink();
            return Text(_kWh(value), style: const TextStyle(color: Colors.white70, fontSize: 10));
          },
        ),
      ),
      rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
      topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
      bottomTitles: AxisTitles(
        axisNameSize: 22,
        axisNameWidget: const Padding(
          padding: EdgeInsets.only(top: 6),
          child: Text('Timestamp', style: TextStyle(color: Colors.white70, fontSize: 12)),
        ),
        sideTitles: SideTitles(
          showTitles: true,
          reservedSize: 28,
          interval: max(1, (_records.length / 6).floorToDouble()),
          getTitlesWidget: (value, meta) {
            final i = value.toInt();
            if (i < 0 || i >= _records.length) return const SizedBox.shrink();
            return Text(DateFormat('HH:mm').format(_records[i].timestamp),
                style: const TextStyle(color: Colors.white70, fontSize: 10));
          },
        ),
      ),
    );
  }

  Widget _buildDataTable(BuildContext context) {
    final theme = Theme.of(context);
    final headers = ['Current 1', 'Current 2', 'Current 3', 'Current 4'];

    return _GlassContainer(
      child: Column(
        children: [
          IntrinsicHeight(
            child: Row(
              children: [
                _buildHeaderCell('Timestamp', theme),
                const VerticalDivider(width: 1, color: Colors.white12),
                _buildHeaderCell(
                  '${headers[_selectedTableCurrent]} (kWh)',
                  theme,
                  onTap: () => _showCurrentPicker(context, headers),
                  hasDropdown: true,
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: Colors.white12),
          ..._records.map((record) {
            final value = record.getValue(_selectedTableCurrent);
            return IntrinsicHeight(
              child: Row(
                children: [
                  _buildDataCell(DateFormat('yyyy-MM-dd\nHH:mm:ss').format(record.timestamp), theme),
                  const VerticalDivider(width: 1, color: Colors.white12),
                  _buildDataCell(value.toStringAsFixed(3), theme),
                ],
              ),
            );
          }).expand((w) => [w, const Divider(height: 1, color: Colors.white12)]).toList()
            ..removeLast(),
        ],
      ),
    );
  }

  void _showCurrentPicker(BuildContext context, List<String> headers) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (_) => ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: Container(
            color: const Color(0xFF1C1C1E).withOpacity(0.85),
            child: ListView.builder(
              shrinkWrap: true,
              itemCount: headers.length,
              itemBuilder: (context, index) {
                final isSelected = index == _selectedTableCurrent;
                return ListTile(
                  title: Text(
                    '${headers[index]} (kWh)',
                    style: TextStyle(
                      color: isSelected ? Theme.of(context).colorScheme.primary : Colors.white,
                      fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                    ),
                  ),
                  trailing: isSelected ? const Icon(Icons.check, color: Colors.white70) : null,
                  tileColor: isSelected ? Theme.of(context).colorScheme.primary.withOpacity(0.18) : Colors.transparent,
                  onTap: () {
                    setState(() => _selectedTableCurrent = index);
                    Navigator.of(context).pop();
                  },
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderCell(String text, ThemeData theme, {VoidCallback? onTap, bool hasDropdown = false}) {
    return Expanded(
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                text,
                textAlign: TextAlign.center,
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: Colors.white70,
                  fontWeight: FontWeight.w700,
                ),
              ),
              if (hasDropdown) ...[
                const SizedBox(width: 4),
                const Icon(Icons.arrow_drop_down, color: Colors.white70, size: 20),
              ]
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDataCell(String text, ThemeData theme) {
    return Expanded(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
        child: Text(
          text,
          textAlign: TextAlign.center,
          style: theme.textTheme.bodyMedium?.copyWith(color: Colors.white),
        ),
      ),
    );
  }

  (double, double) _niceBounds(List<double> values) {
    if (values.isEmpty) return (0, 1);
    final minV = values.reduce(min);
    final maxV = values.reduce(max);
    if (minV == maxV) return (minV * 0.9, maxV * 1.1);

    final range = maxV - minV;
    final mag = pow(10, (log(range) / ln10).floor());
    double niceRange = (range / mag).ceil() * mag.toDouble();
    if (niceRange == 0) niceRange = range;

    final minY = (minV / mag).floor() * mag.toDouble();
    final maxY = minY + niceRange;
    return (minY, maxY);
  }

  String _kWh(double v) => '${(v / 1000).toStringAsFixed(1)}k';
}

class _GraphSwitch extends StatelessWidget {
  const _GraphSwitch({required this.isBreakdown, required this.onToggle});
  final bool isBreakdown;
  final ValueChanged<bool> onToggle;

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        _chip(context, 'Breakdown', isBreakdown, () => onToggle(true)),
        const SizedBox(width: 8),
        _chip(context, 'Total', !isBreakdown, () => onToggle(false)),
      ],
    );
  }

  Widget _chip(BuildContext context, String label, bool selected, VoidCallback onTap) {
    final theme = Theme.of(context);
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
        decoration: BoxDecoration(
          color: selected ? theme.colorScheme.primary.withOpacity(0.85) : Colors.black26,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(color: Colors.white24),
        ),
        child: Row(
          children: [
            AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              width: 8,
              height: 8,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: selected ? Colors.white : Colors.white54,
              ),
            ),
            const SizedBox(width: 8),
            Text(
              label,
              style: TextStyle(
                color: selected ? Colors.white : Colors.white70,
                fontWeight: selected ? FontWeight.w700 : FontWeight.w400,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ChartLegend extends StatelessWidget {
  const _ChartLegend({required this.colors});
  final List<Color> colors;

  @override
  Widget build(BuildContext context) {
    final textColor = Colors.white.withOpacity(0.9);
    return Wrap(
      spacing: 16,
      runSpacing: 8,
      alignment: WrapAlignment.center,
      children: List.generate(colors.length, (index) {
        return Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(width: 10, height: 10, decoration: BoxDecoration(shape: BoxShape.circle, color: colors[index])),
            const SizedBox(width: 6),
            Text('Current ${index + 1}', style: TextStyle(color: textColor, fontSize: 12)),
          ],
        );
      }),
    );
  }
}

class _GlassContainer extends StatelessWidget {
  const _GlassContainer({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 6, sigmaY: 6),
        child: Container(
          decoration: BoxDecoration(
            color: const Color(0xFF1C1C1E).withOpacity(0.38),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: Colors.white.withOpacity(0.10)),
          ),
          child: child,
        ),
      ),
    );
  }
}

// ===== lib/features/dashboard/screens/relay_schedule_screen.dart =====

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:AutoAir/features/dashboard/models/relay_model.dart';
import 'package:AutoAir/features/dashboard/models/schedule_model.dart';
import 'package:AutoAir/widgets/app_background.dart';

class RelayScheduleScreen extends StatefulWidget {
  const RelayScheduleScreen({Key? key}) : super(key: key);

  @override
  State<RelayScheduleScreen> createState() => _RelayScheduleScreenState();
}

class _RelayScheduleScreenState extends State<RelayScheduleScreen> {
  late List<RelaySchedule> _schedules;
  int _filterIndex = 0;

  @override
  void initState() {
    super.initState();
    _schedules = List.generate(
      10,
          (index) => RelaySchedule(
        id: index + 1,
        title: 'Schedule ${index + 1}',
        timeRange: '12:00 AM  12:00 AM',
        days: 'Mon  Tue  Wed  Thu  Fri',
        isActive: index.isEven,
      ),
    );
  }

  List<RelaySchedule> get _visible {
    if (_filterIndex == 1) return _schedules.where((s) => s.isActive).toList();
    if (_filterIndex == 2) return _schedules.where((s) => !s.isActive).toList();
    return _schedules;
  }

  @override
  Widget build(BuildContext context) {
    final relay = ModalRoute.of(context)!.settings.arguments as Relay;
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          centerTitle: true,
          title: Text(
            'Schedules',
            style: TextStyle(
              color: isDark ? Colors.white : Colors.black,
              fontWeight: FontWeight.w700,
            ),
          ),
          leading: IconButton(
            icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
            onPressed: () => Navigator.of(context).pop(),
          ),
          actions: [
            IconButton(
              icon: Icon(Icons.help_outline, color: isDark ? Colors.white70 : Colors.black54),
              onPressed: () => _showHowItWorks(context),
            ),
            const SizedBox(width: 6),
          ],
        ),
        floatingActionButton: FloatingActionButton.extended(
          onPressed: () => _openEditor(context),
          label: const Text('Add Schedule'),
          icon: const Icon(Icons.add),
        ),
        body: ListView(
          padding: const EdgeInsets.fromLTRB(16, 8, 16, 96),
          children: [
            _HeaderCard(relayName: relay.name, onAdd: () => _openEditor(context)),
            const SizedBox(height: 16),
            _FilterChips(
              index: _filterIndex,
              onChanged: (i) => setState(() => _filterIndex = i),
            ),
            const SizedBox(height: 8),
            if (_visible.isEmpty)
              _EmptyState(onAdd: () => _openEditor(context))
            else
              ..._visible.map((s) => Padding(
                padding: const EdgeInsets.only(bottom: 12),
                child: _ScheduleCard(
                  schedule: s,
                  onToggle: (v) => setState(() => s.isActive = v),
                  onEdit: () => _openEditor(context, s),
                  onMore: () => _showItemMenu(context, s),
                ),
              )),
          ],
        ),
      ),
    );
  }

  void _openEditor(BuildContext context, [RelaySchedule? schedule]) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (_) {
        return ClipRRect(
          borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
            child: Container(
              color: const Color(0xFF1C1C1E).withOpacity(0.8),
              padding: EdgeInsets.only(
                left: 16,
                right: 16,
                top: 12,
                bottom: 16 + MediaQuery.of(context).viewInsets.bottom,
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    width: 44,
                    height: 4,
                    decoration: BoxDecoration(
                      color: Colors.white24,
                      borderRadius: BorderRadius.circular(4),
                    ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    schedule == null ? 'New Schedule' : 'Edit ${schedule.title}',
                    style: Theme.of(context).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w800),
                  ),
                  const SizedBox(height: 20),
                  // Placeholder fields  hook up to your model later
                  _Field(label: 'Title', initial: schedule?.title ?? ''),
                  const SizedBox(height: 12),
                  _Field(label: 'Time Range', initial: schedule?.timeRange ?? '08:00 AM  06:00 PM'),
                  const SizedBox(height: 12),
                  _Field(label: 'Days', initial: schedule?.days ?? 'Mon  Wed  Fri'),
                  const SizedBox(height: 20),
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(Icons.save),
                      label: const Text('Save'),
                    ),
                  ),
                  const SizedBox(height: 6),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  void _showItemMenu(BuildContext context, RelaySchedule s) async {
    final selected = await showMenu<String>(
      context: context,
      position: const RelativeRect.fromLTRB(1000, 100, 16, 0),
      color: const Color(0xFF2A2A2C),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      items: const [
        PopupMenuItem(value: 'duplicate', child: Text('Duplicate')),
        PopupMenuItem(value: 'delete', child: Text('Delete')),
      ],
    );
    if (selected == 'duplicate') {
      setState(() {
        _schedules.add(RelaySchedule(
          id: _schedules.length + 1,
          title: '${s.title} (copy)',
          timeRange: s.timeRange,
          days: s.days,
          isActive: s.isActive,
        ));
      });
    } else if (selected == 'delete') {
      setState(() => _schedules.removeWhere((x) => x.id == s.id));
    }
  }

  void _showHowItWorks(BuildContext context) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        backgroundColor: const Color(0xFF1C1C1E),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: const Text('How schedules work'),
        content: const Text(
          'Create one or more time ranges and choose the days. '
              'Active schedules will toggle the relay automatically.',
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text('Got it')),
        ],
      ),
    );
  }
}

class _HeaderCard extends StatelessWidget {
  const _HeaderCard({required this.relayName, required this.onAdd});
  final String relayName;
  final VoidCallback onAdd;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
        child: Container(
          padding: const EdgeInsets.fromLTRB(16, 16, 16, 16),
          decoration: BoxDecoration(
            color: const Color(0xFF1C1C1E).withOpacity(0.4),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: Row(
            children: [
              Container(
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: LinearGradient(
                    colors: [theme.colorScheme.primary, theme.colorScheme.primary.withOpacity(0.2)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                ),
                child: const Icon(Icons.flash_on, color: Colors.white),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Relay', style: theme.textTheme.labelMedium?.copyWith(color: Colors.white70)),
                    Text(
                      relayName,
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                      style: theme.textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w800),
                    ),
                  ],
                ),
              ),
              TextButton.icon(
                onPressed: onAdd,
                style: TextButton.styleFrom(
                  backgroundColor: theme.colorScheme.primary.withOpacity(0.14),
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                ),
                icon: const Icon(Icons.add, size: 18),
                label: const Text('Add'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FilterChips extends StatelessWidget {
  const _FilterChips({required this.index, required this.onChanged});
  final int index;
  final ValueChanged<int> onChanged;

  @override
  Widget build(BuildContext context) {
    final items = const ['All', 'Active', 'Inactive'];
    return Wrap(
      spacing: 8,
      children: List.generate(items.length, (i) {
        final selected = i == index;
        return ChoiceChip(
          label: Text(items[i]),
          selected: selected,
          onSelected: (_) => onChanged(i),
          labelStyle: TextStyle(
            color: selected ? Colors.black : Colors.white,
            fontWeight: FontWeight.w600,
          ),
          selectedColor: Colors.white,
          backgroundColor: const Color(0xFF2A2A2C),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        );
      }),
    );
  }
}

class _ScheduleCard extends StatelessWidget {
  const _ScheduleCard({
    required this.schedule,
    required this.onToggle,
    required this.onEdit,
    required this.onMore,
  });

  final RelaySchedule schedule;
  final ValueChanged<bool> onToggle;
  final VoidCallback onEdit;
  final VoidCallback onMore;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final active = schedule.isActive;

    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 220),
          curve: Curves.easeOut,
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: const Color(0xFF1C1C1E).withOpacity(0.4),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: active ? theme.colorScheme.primary.withOpacity(0.45) : Colors.white.withOpacity(0.1),
              width: 1.2,
            ),
            boxShadow: active
                ? [
              BoxShadow(
                color: theme.colorScheme.primary.withOpacity(0.25),
                blurRadius: 18,
                spreadRadius: 0.5,
                offset: const Offset(0, 6),
              )
            ]
                : [],
          ),
          child: Row(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _Bullet(active: active),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Expanded(
                          child: Text(
                            schedule.title,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                            style: theme.textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.w800,
                            ),
                          ),
                        ),
                        IconButton(
                          onPressed: onMore,
                          icon: const Icon(Icons.more_horiz, color: Colors.white70),
                          splashRadius: 18,
                        ),
                      ],
                    ),
                    const SizedBox(height: 6),
                    // Time range
                    Row(
                      children: [
                        const Icon(Icons.schedule, size: 16, color: Colors.white70),
                        const SizedBox(width: 6),
                        Flexible(
                          child: Text(
                            schedule.timeRange,
                            style: theme.textTheme.bodyMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                              letterSpacing: 0.2,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    // Days
                    Row(
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        const Icon(Icons.calendar_today_rounded, size: 14, color: Colors.white54),
                        const SizedBox(width: 6),
                        Flexible(
                          child: Text(
                            schedule.days,
                            style: theme.textTheme.bodySmall?.copyWith(color: Colors.white70),
                            maxLines: 2,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    // Actions
                    Row(
                      children: [
                        OutlinedButton.icon(
                          onPressed: onEdit,
                          style: OutlinedButton.styleFrom(
                            side: BorderSide(color: Colors.white.withOpacity(0.12)),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 10),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                          ),
                          icon: const Icon(Icons.edit, size: 16),
                          label: const Text('Edit'),
                        ),
                        const Spacer(),
                        Switch(
                          value: active,
                          onChanged: onToggle,
                          activeColor: Colors.white,
                          activeTrackColor: Theme.of(context).colorScheme.primary,
                          materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Bullet extends StatelessWidget {
  const _Bullet({required this.active});
  final bool active;

  @override
  Widget build(BuildContext context) {
    final color = active ? Theme.of(context).colorScheme.primary : Colors.white24;
    return Container(
      width: 10,
      height: 10,
      margin: const EdgeInsets.only(top: 6),
      decoration: BoxDecoration(
        color: color,
        shape: BoxShape.circle,
        boxShadow: active
            ? [BoxShadow(color: color.withOpacity(0.5), blurRadius: 10, spreadRadius: 1)]
            : [],
      ),
    );
  }
}

class _EmptyState extends StatelessWidget {
  const _EmptyState({required this.onAdd});
  final VoidCallback onAdd;

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
        child: Container(
          padding: const EdgeInsets.fromLTRB(18, 24, 18, 24),
          decoration: BoxDecoration(
            color: const Color(0xFF1C1C1E).withOpacity(0.4),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: Column(
            children: [
              const Icon(Icons.event_busy, size: 36, color: Colors.white54),
              const SizedBox(height: 10),
              const Text('No schedules yet', style: TextStyle(fontWeight: FontWeight.w700)),
              const SizedBox(height: 6),
              const Text(
                'Create your first automation to turn the relay on/off at specific times.',
                textAlign: TextAlign.center,
                style: TextStyle(color: Colors.white70),
              ),
              const SizedBox(height: 12),
              ElevatedButton.icon(
                onPressed: onAdd,
                icon: const Icon(Icons.add),
                label: const Text('Add Schedule'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Field extends StatelessWidget {
  const _Field({required this.label, required this.initial});
  final String label;
  final String initial;

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: TextEditingController(text: initial),
      decoration: InputDecoration(
        labelText: label,
        filled: true,
        fillColor: const Color(0xFF2A2A2C),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.12)),
        ),
      ),
    );
  }
}

// ===== lib/features/dashboard/widgets/fan_control_settings_tab.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/features/dashboard/screens/dashboard_screen.dart';

class FanControlSettingsTab extends StatefulWidget {
  const FanControlSettingsTab({Key? key}) : super(key: key);

  @override
  State<FanControlSettingsTab> createState() => _FanControlSettingsTabState();
}

class _FanControlSettingsTabState extends State<FanControlSettingsTab> {
  bool _isManualMode = false;
  bool _isFanOnInAuto = false;
  int _turnOffTemp = 24;
  int _turnOnTemp = 28;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return DashboardCard(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Text(
              'Fan Control Settings',
              textAlign: TextAlign.center,
              style: theme.textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.w800,
                letterSpacing: 0.2,
              ),
            ),
            const SizedBox(height: 24),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text('Mode:', style: TextStyle(fontSize: 16)),
                _CustomModeToggle(
                  labelOn: 'Manual',
                  labelOff: 'Auto',
                  isActive: _isManualMode,
                  onToggle: (value) {
                    setState(() {
                      _isManualMode = value;
                    });
                  },
                ),
              ],
            ),
            const SizedBox(height: 16),
            const Divider(color: Colors.white24, height: 1),
            const SizedBox(height: 32),
            SizedBox(
              height: 180,
              child: AnimatedSwitcher(
                duration: const Duration(milliseconds: 300),
                transitionBuilder: (child, animation) {
                  return FadeTransition(opacity: animation, child: child);
                },
                child: _isManualMode ? _buildManualMode(theme) : _buildAutoMode(theme),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAutoMode(ThemeData theme) {
    return Column(
      key: const ValueKey('auto_mode'),
      children: [
        Text(
          'Auto Mode',
          style: theme.textTheme.titleMedium?.copyWith(fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 24),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text('Fan State:', style: TextStyle(fontSize: 16)),
            _CustomModeToggle(
              labelOn: 'On',
              labelOff: 'Off',
              isActive: _isFanOnInAuto,
              onToggle: (value) {
                setState(() {
                  _isFanOnInAuto = value;
                });
              },
            ),
          ],
        )
      ],
    );
  }

  Widget _buildManualMode(ThemeData theme) {
    return Column(
      key: const ValueKey('manual_mode'),
      children: [
        Text(
          'Manual Mode',
          style: theme.textTheme.titleMedium?.copyWith(fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 24),
        _TemperatureControl(
          label: 'Turn off below Temp (C):',
          value: _turnOffTemp,
          onChanged: (val) => setState(() => _turnOffTemp = val),
        ),
        const SizedBox(height: 16),
        _TemperatureControl(
          label: 'Turn on above Temp (C):',
          value: _turnOnTemp,
          onChanged: (val) => setState(() => _turnOnTemp = val),
        ),
      ],
    );
  }
}

class _CustomModeToggle extends StatelessWidget {
  const _CustomModeToggle({
    required this.labelOn,
    required this.labelOff,
    required this.isActive,
    required this.onToggle,
  });

  final String labelOn;
  final String labelOff;
  final bool isActive;
  final ValueChanged<bool> onToggle;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return GestureDetector(
      onTap: () => onToggle(!isActive),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        width: 105,
        height: 40,
        padding: const EdgeInsets.all(4),
        decoration: BoxDecoration(
          color: isActive ? theme.colorScheme.primary : Colors.grey.shade800,
          borderRadius: BorderRadius.circular(30),
        ),
        child: Stack(
          children: [
            AnimatedAlign(
              duration: const Duration(milliseconds: 300),
              alignment: isActive ? Alignment.centerRight : Alignment.centerLeft,
              curve: Curves.easeOut,
              child: Container(
                width: 32,
                height: 32,
                decoration: const BoxDecoration(
                  color: Colors.white,
                  shape: BoxShape.circle,
                ),
              ),
            ),
            AnimatedAlign(
              duration: const Duration(milliseconds: 300),
              alignment: isActive ? Alignment.centerLeft : Alignment.centerRight,
              curve: Curves.easeOut,
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16.0),
                child: Text(
                  isActive ? labelOn : labelOff,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _TemperatureControl extends StatelessWidget {
  const _TemperatureControl({
    required this.label,
    required this.value,
    required this.onChanged,
  });

  final String label;
  final int value;
  final ValueChanged<int> onChanged;

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Expanded(
          child: Text(label),
        ),
        Row(
          children: [
            IconButton(
              icon: const Icon(Icons.remove),
              onPressed: () => onChanged(value - 1),
              iconSize: 20,
            ),
            Container(
              width: 50,
              padding: const EdgeInsets.symmetric(vertical: 8),
              decoration: BoxDecoration(
                color: Colors.grey.shade800,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(
                value.toString(),
                textAlign: TextAlign.center,
                style: const TextStyle(fontSize: 16),
              ),
            ),
            IconButton(
              icon: const Icon(Icons.add),
              onPressed: () => onChanged(value + 1),
              iconSize: 20,
            ),
          ],
        )
      ],
    );
  }
}

// ===== lib/features/dashboard/widgets/relay_settings_tab.dart =====

import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:AutoAir/features/dashboard/models/relay_model.dart';
import 'package:AutoAir/providers/dashboard_provider.dart';
import 'package:AutoAir/themes/custom_colors.dart';

class RelaySettingsTab extends StatelessWidget {
  const RelaySettingsTab({
    Key? key,
    required this.provider,
  }) : super(key: key);

  final DashboardProvider provider;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return ClipRRect(
      borderRadius: BorderRadius.circular(20),
      child: BackdropFilter(
        filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8),
        child: Container(
          key: const ValueKey('relay_settings'),
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: const Color(0xFF141416).withOpacity(0.18),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(color: Colors.white.withOpacity(0.08)),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 16,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Text(
                'Relay Settings',
                textAlign: TextAlign.center,
                style: theme.textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.w800,
                  letterSpacing: 0.2,
                ),
              ),
              const SizedBox(height: 16),
              if (provider.relays.isEmpty)
                const Padding(
                  padding: EdgeInsets.all(24.0),
                  child: Center(child: Text('No relays found for this device.')),
                )
              else
                ...provider.relays.map((relay) {
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 14.0),
                    child: _RelayCard(
                      relay: relay,
                      onToggle: (value) => provider.toggleRelay(relay.id, value),
                    ),
                  );
                }).toList(),
            ],
          ),
        ),
      ),
    );
  }
}

class _RelayCard extends StatefulWidget {
  const _RelayCard({
    required this.relay,
    required this.onToggle,
  });

  final Relay relay;
  final ValueChanged<bool> onToggle;

  @override
  State<_RelayCard> createState() => _RelayCardState();
}

class _RelayCardState extends State<_RelayCard> {
  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final custom = theme.extension<CustomColors>()!;

    final bool isOn = widget.relay.isOn;
    final double currentA = widget.relay.amperage;

    return AnimatedContainer(
      duration: const Duration(milliseconds: 220),
      curve: Curves.easeOut,
      decoration: BoxDecoration(
        color: const Color(0xFF0F0F10),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(
          color: isOn ? custom.successBorder! : Colors.white.withOpacity(0.06),
        ),
      ),
      padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Row(
            children: [
              Text(
                widget.relay.name,
                style: theme.textTheme.titleMedium?.copyWith(
                  color: Colors.white,
                  fontWeight: FontWeight.w700,
                ),
              ),
              const Spacer(),
              Switch(
                value: isOn,
                onChanged: widget.onToggle,
                thumbColor: MaterialStateProperty.resolveWith(
                      (_) => isOn ? Colors.white : Colors.white70,
                ),
                trackColor: MaterialStateProperty.resolveWith(
                      (_) => isOn ? custom.successTrack! : Colors.white10,
                ),
                overlayColor: MaterialStateProperty.resolveWith(
                      (_) => isOn
                      ? custom.success!.withOpacity(0.15)
                      : Colors.white.withOpacity(0.05),
                ),
                materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
              ),
            ],
          ),
          const SizedBox(height: 6),
          Container(
            alignment: Alignment.center,
            padding: const EdgeInsets.symmetric(vertical: 10),
            decoration: BoxDecoration(
              color: const Color(0xFF151517),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.white.withOpacity(0.04)),
            ),
            child: _SegmentDisplayText(
              text: '${currentA.toStringAsFixed(2)}  A',
            ),
          ),
          const SizedBox(height: 10),
          _DimButton(
            label: 'Manual',
            onPressed: () {},
          ),
          const SizedBox(height: 8),
          _PrimaryButton(
            label: 'Configure Schedule',
            onPressed: () {},
            color: Theme.of(context).colorScheme.primary,
          ),
        ],
      ),
    );
  }
}

class _SegmentDisplayText extends StatelessWidget {
  const _SegmentDisplayText({required this.text});

  final String text;

  @override
  Widget build(BuildContext context) {
    return FittedBox(
      fit: BoxFit.scaleDown,
      child: Text(
        text,
        style: const TextStyle(
          fontFamily: 'DigitalNumbers',
          fontFeatures: [ui.FontFeature.tabularFigures()],
          fontSize: 34,
          letterSpacing: 2.0,
          color: Colors.white,
          height: 1.0,
        ),
      ),
    );
  }
}

class _DimButton extends StatelessWidget {
  const _DimButton({required this.label, required this.onPressed});

  final String label;
  final VoidCallback? onPressed;

  @override
  Widget build(BuildContext context) {
    const bg = Color(0xFF232325);
    return SizedBox(
      height: 40,
      child: TextButton(
        style: TextButton.styleFrom(
          backgroundColor: bg,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
            side: BorderSide(color: Colors.white.withOpacity(0.08)),
          ),
          textStyle: const TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
          ),
        ),
        onPressed: onPressed,
        child: Text(label),
      ),
    );
  }
}

class _PrimaryButton extends StatelessWidget {
  const _PrimaryButton({
    required this.label,
    required this.onPressed,
    required this.color,
  });

  final String label;
  final VoidCallback onPressed;
  final Color color;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 40,
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          textStyle: const TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w700,
          ),
          padding: const EdgeInsets.symmetric(horizontal: 12),
          elevation: 0,
        ),
        onPressed: onPressed,
        child: Text(label),
      ),
    );
  }
}

// ===== lib/features/devices/models/device_model.dart =====

import 'package:flutter/foundation.dart';

enum DeviceStatus { online, offline, updating }

class WifiConfig {
  final String? ssid;
  final String? password;
  final bool isStatic;
  final String? ipAddress;
  final String? gateway;
  final String? subnet;

  WifiConfig({
    this.ssid,
    this.password,
    this.isStatic = false,
    this.ipAddress,
    this.gateway,
    this.subnet,
  });

  factory WifiConfig.fromJson(Map<String, dynamic> json) {
    return WifiConfig(
      ssid: json['ssid'],
      password: json['password'],
      isStatic: json['is_static'] ?? false,
      ipAddress: json['ip_address'],
      gateway: json['gateway'],
      subnet: json['subnet'],
    );
  }
}

class MqttConfig {
  final String? host;
  final int? port;
  final String? clientId;
  final String? authUsername;
  final String? authPassword;

  MqttConfig({
    this.host,
    this.port,
    this.clientId,
    this.authUsername,
    this.authPassword,
  });

  factory MqttConfig.fromJson(Map<String, dynamic> json) {
    return MqttConfig(
      host: json['host'],
      port: json['port'],
      clientId: json['client_id'],
      authUsername: json['auth_username'],
      authPassword: json['auth_password'],
    );
  }
}

class TimeConfig {
  final String? ntpServer;
  final String? timezone;

  TimeConfig({this.ntpServer, this.timezone});

  factory TimeConfig.fromJson(Map<String, dynamic> json) {
    return TimeConfig(
      ntpServer: json['ntp_server'],
      timezone: json['timezone'],
    );
  }
}

class FanConfig {
  final String? mode;
  final bool isOn;
  final int? minTemp;
  final int? maxTemp;

  FanConfig({this.mode, this.isOn = false, this.minTemp, this.maxTemp});

  factory FanConfig.fromJson(Map<String, dynamic> json) {
    return FanConfig(
      mode: json['mode'],
      isOn: json['is_on'] ?? false,
      minTemp: json['min_temp'],
      maxTemp: json['max_temp'],
    );
  }
}

class DeviceConfig {
  final WifiConfig wifi;
  final MqttConfig mqtt;
  final TimeConfig time;
  final FanConfig fan;

  DeviceConfig({
    required this.wifi,
    required this.mqtt,
    required this.time,
    required this.fan,
  });

  factory DeviceConfig.fromJson(Map<String, dynamic> json) {
    return DeviceConfig(
      wifi: WifiConfig.fromJson(json['wifi'] ?? {}),
      mqtt: MqttConfig.fromJson(json['mqtt'] ?? {}),
      time: TimeConfig.fromJson(json['time'] ?? {}),
      fan: FanConfig.fromJson(json['fan'] ?? {}),
    );
  }
}

class Device {
  final String id;
  final String name;
  final String serialNumber;
  final String? description;
  final DeviceStatus status;
  final DeviceConfig config;

  Device({
    required this.id,
    required this.name,
    required this.serialNumber,
    required this.status,
    required this.config,
    this.description,
  });

  factory Device.fromJson(Map<String, dynamic> json) {
    return Device(
      id: json['id']?.toString() ?? 'N/A',
      name: json['name'] ?? 'Unnamed Device',
      serialNumber: json['serial_number'] ?? 'N/A',
      description: json['description'],
      status: _parseStatus(json['status']),
      config: DeviceConfig.fromJson(json['config'] ?? {}),
    );
  }

  static DeviceStatus _parseStatus(dynamic statusValue) {
    if (statusValue is bool) {
      return statusValue ? DeviceStatus.online : DeviceStatus.offline;
    }
    if (statusValue is String) {
      switch (statusValue.toLowerCase()) {
        case 'online':
          return DeviceStatus.online;
        case 'updating':
          return DeviceStatus.updating;
        default:
          return DeviceStatus.offline;
      }
    }
    return DeviceStatus.offline;
  }

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
          other is Device &&
              runtimeType == other.runtimeType &&
              id == other.id &&
              serialNumber == other.serialNumber;

  @override
  int get hashCode => id.hashCode ^ serialNumber.hashCode;

  @override
  String toString() {
    return 'Device{id: $id, name: $name, serialNumber: $serialNumber}';
  }
}

// ===== lib/features/devices/screens/add_device_screen.dart =====

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:AutoAir/providers/device_provider.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';
import 'package:AutoAir/themes/custom_colors.dart';

class AddDeviceScreen extends StatefulWidget {
  const AddDeviceScreen({Key? key}) : super(key: key);

  @override
  State<AddDeviceScreen> createState() => _AddDeviceScreenState();
}

class _AddDeviceScreenState extends State<AddDeviceScreen> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _serialNumberController = TextEditingController();
  final _pinController = TextEditingController();
  final _descriptionController = TextEditingController();
  bool _isLoading = false;

  @override
  void dispose() {
    _nameController.dispose();
    _serialNumberController.dispose();
    _pinController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }

  Future<void> _saveDevice() async {
    if (!(_formKey.currentState?.validate() ?? false)) return;
    setState(() => _isLoading = true);
    final deviceProvider = Provider.of<DeviceProvider>(context, listen: false);
    try {
      await deviceProvider.addDevice(
        name: _nameController.text,
        serialNumber: _serialNumberController.text,
        pin: _pinController.text,
        description: _descriptionController.text.isNotEmpty ? _descriptionController.text : null,
      );
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Device added successfully!'), backgroundColor: Colors.green),
        );
        Navigator.pop(context);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: ${e.toString()}'), backgroundColor: Colors.red),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;
    final customColors = theme.extension<CustomColors>()!;
    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          title: Text('Add New Device', style: TextStyle(color: isDarkMode ? Colors.white : Colors.black)),
          centerTitle: true,
          leading: IconButton(
            icon: Icon(Icons.arrow_back, color: isDarkMode ? Colors.white : Colors.black),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ),
        body: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 32.0),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: <Widget>[
                    Image.asset(AppAssets.logo, height: 60),
                    const SizedBox(height: 8),
                    Text(
                      'AutoAir',
                      textAlign: TextAlign.center,
                      style: theme.textTheme.headlineMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                        color: isDarkMode ? Colors.white : Colors.black,
                      ),
                    ),
                    const SizedBox(height: 48),
                    _buildTextFormField(
                      controller: _nameController,
                      label: 'Device Name',
                      hint: 'e.g., Living Room AC',
                      isRequired: true,
                      isDarkMode: isDarkMode,
                    ),
                    const SizedBox(height: 24),
                    _buildTextFormField(
                      controller: _serialNumberController,
                      label: 'Serial Number',
                      hint: 'e.g., AA-LIV-0001',
                      isRequired: true,
                      isDarkMode: isDarkMode,
                    ),
                    const SizedBox(height: 24),
                    _buildTextFormField(
                      controller: _pinController,
                      label: 'PIN',
                      hint: 'Enter device PIN',
                      isRequired: true,
                      isDarkMode: isDarkMode,
                      isObscured: true,
                      keyboardType: TextInputType.number,
                    ),
                    const SizedBox(height: 24),
                    _buildTextFormField(
                      controller: _descriptionController,
                      label: 'Description',
                      hint: 'e.g., Main unit in living room',
                      isRequired: false,
                      isDarkMode: isDarkMode,
                    ),
                    const SizedBox(height: 32),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: customColors.primaryAction,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                      ),
                      onPressed: _isLoading ? null : _saveDevice,
                      child: _isLoading ? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2)) : const Text('Save Device'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTextFormField({
    required TextEditingController controller,
    required String label,
    required String hint,
    required bool isRequired,
    required bool isDarkMode,
    bool isObscured = false,
    TextInputType keyboardType = TextInputType.text,
  }) {
    final subtextColor = isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600;
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Text(label, style: TextStyle(color: subtextColor, fontSize: 16)),
            if (isRequired) const Text(' *', style: TextStyle(color: Colors.red, fontSize: 16)),
          ],
        ),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          obscureText: isObscured,
          keyboardType: keyboardType,
          style: TextStyle(color: isDarkMode ? Colors.white : Colors.black),
          decoration: _buildInputDecoration(isDarkMode, hint),
          validator: (value) {
            if (isRequired && (value == null || value.isEmpty)) return 'This field is required';
            return null;
          },
        ),
      ],
    );
  }

  InputDecoration _buildInputDecoration(bool isDarkMode, String hint) {
    return InputDecoration(
      hintText: hint,
      filled: true,
      fillColor: isDarkMode ? Colors.grey.shade900.withOpacity(0.5) : Colors.white,
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade700 : Colors.grey.shade300),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: isDarkMode ? Colors.grey.shade400 : Colors.deepPurple),
      ),
      contentPadding: const EdgeInsets.symmetric(vertical: 14, horizontal: 16),
    );
  }
}

// ===== lib/features/devices/screens/device_list_screen.dart =====

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:AutoAir/providers/device_provider.dart';
import 'package:AutoAir/features/devices/models/device_model.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';
import 'package:AutoAir/themes/custom_colors.dart';

class DeviceListScreen extends StatefulWidget {
  const DeviceListScreen({Key? key}) : super(key: key);

  @override
  State<DeviceListScreen> createState() => _DeviceListScreenState();
}

class _DeviceListScreenState extends State<DeviceListScreen> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      Provider.of<DeviceProvider>(context, listen: false).fetchDevices();
    });
  }

  Future<void> _handleRefresh() async {
    await Provider.of<DeviceProvider>(context, listen: false).fetchDevices();
  }

  Future<void> _handleProceed() async {
    final provider = Provider.of<DeviceProvider>(context, listen: false);
    final selectedDevice = provider.selectedDevice;

    if (selectedDevice == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please select a device to proceed.'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    await provider.persistActiveDevice(selectedDevice);

    if (!mounted) return;

    final bool isConfigured = selectedDevice.config.wifi.ssid != null &&
        selectedDevice.config.wifi.ssid!.isNotEmpty;

    if (isConfigured) {
      Navigator.pushNamedAndRemoveUntil(context, '/dashboard', (route) => false);
    } else {
      Navigator.pushNamed(context, '/system_time');
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: RefreshIndicator(
            onRefresh: _handleRefresh,
            child: ListView(
              physics: const AlwaysScrollableScrollPhysics(),
              padding: const EdgeInsets.fromLTRB(24.0, 24.0, 24.0, 100.0),
              children: [
                _buildHeader(theme, isDarkMode),
                const SizedBox(height: 32),
                _buildDeviceListHeader(isDarkMode),
                const SizedBox(height: 16),
                _buildDeviceListBody(),
              ],
            ),
          ),
        ),
        bottomNavigationBar: _buildFooter(theme, isDarkMode),
      ),
    );
  }

  Widget _buildHeader(ThemeData theme, bool isDarkMode) {
    return Column(
      children: [
        Image.asset(AppAssets.logo, height: 60),
        const SizedBox(height: 8),
        Text(
          'AutoAir',
          textAlign: TextAlign.center,
          style: theme.textTheme.headlineMedium?.copyWith(
            fontWeight: FontWeight.bold,
            color: isDarkMode ? Colors.white : Colors.black,
          ),
        ),
      ],
    );
  }

  Widget _buildDeviceListHeader(bool isDarkMode) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          'Devices',
          style: Theme.of(context).textTheme.headlineSmall?.copyWith(
            fontWeight: FontWeight.bold,
            color: isDarkMode ? Colors.white : Colors.black87,
          ),
        ),
        TextButton.icon(
          onPressed: () => Navigator.pushNamed(context, '/add_device'),
          icon: const Icon(Icons.add, size: 18),
          label: const Text('Add Device'),
          style: TextButton.styleFrom(
            foregroundColor: isDarkMode ? Colors.white : Colors.black,
            backgroundColor: isDarkMode ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          ),
        )
      ],
    );
  }

  Widget _buildDeviceListBody() {
    return Consumer<DeviceProvider>(
      builder: (context, provider, child) {
        if (provider.isLoading && provider.devices.isEmpty) {
          return const Center(child: Padding(
            padding: EdgeInsets.symmetric(vertical: 48.0),
            child: CircularProgressIndicator(),
          ));
        }
        if (provider.error != null && provider.devices.isEmpty) {
          return Center(
            child: Padding(
              padding: const EdgeInsets.symmetric(vertical: 48.0),
              child: Text(
                'Error loading devices. Pull to refresh.',
                style: TextStyle(color: Colors.grey.shade400),
              ),
            ),
          );
        }
        if (provider.devices.isEmpty) {
          return Center(
            child: Padding(
              padding: const EdgeInsets.symmetric(vertical: 48.0),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.devices_other, size: 48, color: Colors.grey.shade600),
                  const SizedBox(height: 16),
                  Text(
                    'No devices found',
                    style: TextStyle(color: Colors.grey.shade400, fontSize: 16),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Add a new device to get started.',
                    style: TextStyle(color: Colors.grey.shade500),
                  ),
                ],
              ),
            ),
          );
        }

        return Column(
          children: provider.devices.map((device) {
            final isSelected = provider.selectedDevice == device;
            return Padding(
              padding: const EdgeInsets.only(bottom: 16.0),
              child: InkWell(
                onTap: () => provider.selectDevice(device),
                borderRadius: BorderRadius.circular(12),
                child: DeviceCard(
                  device: device,
                  isSelected: isSelected,
                ),
              ),
            );
          }).toList(),
        );
      },
    );
  }

  Widget _buildFooter(ThemeData theme, bool isDarkMode) {
    final customColors = theme.extension<CustomColors>()!;
    return Container(
      color: Colors.transparent,
      padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 16.0),
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: customColors.primaryAction,
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          textStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
        ),
        onPressed: _handleProceed,
        child: const Text('Proceed'),
      ),
    );
  }
}

class DeviceCard extends StatelessWidget {
  final Device device;
  final bool isSelected;

  const DeviceCard({
    Key? key,
    required this.device,
    this.isSelected = false,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDarkMode = theme.brightness == Brightness.dark;
    final customColors = theme.extension<CustomColors>()!;

    final cardColor = isDarkMode ? Colors.white.withOpacity(0.1) : Colors.white;
    final borderColor = isSelected
        ? customColors.primaryAction
        : (isDarkMode ? Colors.white.withOpacity(0.2) : Colors.grey.shade300);
    final textColor = isDarkMode ? Colors.white : Colors.black87;
    final subtextColor = isDarkMode ? Colors.grey.shade400 : Colors.grey.shade600;

    return Container(
      padding: const EdgeInsets.all(16.0),
      decoration: BoxDecoration(
        color: cardColor,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: borderColor,
          width: isSelected ? 2.0 : 1.0,
        ),
        boxShadow: isDarkMode ? [] : [
          BoxShadow(
            color: Colors.grey.withOpacity(0.1),
            spreadRadius: 2,
            blurRadius: 5,
            offset: const Offset(0, 3),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.device_hub, color: textColor, size: 24),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  device.name,
                  style: theme.textTheme.titleLarge?.copyWith(
                    color: textColor,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          Padding(
            padding: const EdgeInsets.symmetric(vertical: 8.0),
            child: Divider(color: isDarkMode ? Colors.white24 : Colors.grey.shade200),
          ),
          _buildStatusWidget(),
          const SizedBox(height: 12),
          _buildInfoRow('Serial #:', device.serialNumber, textColor, subtextColor),
          const SizedBox(height: 8),
          if (device.config.wifi.ipAddress != null)
            _buildInfoRow('IP Address:', device.config.wifi.ipAddress!, textColor, subtextColor),
          const SizedBox(height: 8),
          if (device.description != null && device.description!.isNotEmpty)
            _buildInfoRow('Description:', device.description!, textColor, subtextColor),
        ],
      ),
    );
  }

  Widget _buildStatusWidget() {
    Color statusColor;
    String statusText;

    switch (device.status) {
      case DeviceStatus.online:
        statusColor = Colors.green;
        statusText = 'Online';
        break;
      case DeviceStatus.offline:
        statusColor = Colors.red;
        statusText = 'Offline';
        break;
      case DeviceStatus.updating:
        statusColor = Colors.blue;
        statusText = 'Updating';
        break;
    }

    return Row(
      children: [
        SizedBox(
          width: 100,
          child: Text(
            'Status:',
            style: TextStyle(color: Colors.grey.shade500, fontSize: 14),
          ),
        ),
        Icon(Icons.circle, color: statusColor, size: 10),
        const SizedBox(width: 8),
        Text(
          statusText,
          style: TextStyle(
              color: statusColor, fontSize: 14, fontWeight: FontWeight.bold),
        ),
      ],
    );
  }

  Widget _buildInfoRow(String label, String value, Color textColor, Color subtextColor) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SizedBox(
          width: 100,
          child: Text(
            label,
            style: TextStyle(color: subtextColor, fontSize: 14),
          ),
        ),
        Expanded(
          child: Text(
            value,
            style: TextStyle(color: textColor, fontSize: 14),
          ),
        ),
      ],
    );
  }
}

// ===== lib/features/reports/screens/hourly_records_screen.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/widgets/app_background.dart';

class HourlyRecordsScreen extends StatefulWidget {
  const HourlyRecordsScreen({Key? key}) : super(key: key);

  @override
  State<HourlyRecordsScreen> createState() => _HourlyRecordsScreenState();
}

class _HourlyRecordsScreenState extends State<HourlyRecordsScreen> {
  final List<Map<String, String>> _records = List.generate(
    20,
        (index) => {
      'timestamp': '2025-08-06\n${(3 + index).toString().padLeft(2, '0')}:47:54',
      'value': (0.123 + (index * 0.001)).toStringAsFixed(3),
    },
  );

  String _selectedCurrent = 'Current 1 (kWh)';

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          title: const Text('Detailed Hourly Records'),
          centerTitle: true,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ),
        body: SingleChildScrollView(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Container(
                height: 250,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.grey.shade900.withOpacity(0.5),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Center(
                  child: Text(
                    'Line Chart Placeholder',
                    style: TextStyle(color: Colors.white54),
                  ),
                ),
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {},
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.grey.shade800,
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                child: const Text('Download as Excel (CSV)'),
              ),
              const SizedBox(height: 24),
              _buildDataTable(theme),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDataTable(ThemeData theme) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.grey.shade900.withOpacity(0.3),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        children: [
          _buildHeaderRow(theme),
          const Divider(color: Colors.white24, height: 1),
          ListView.separated(
            physics: const NeverScrollableScrollPhysics(),
            shrinkWrap: true,
            itemCount: _records.length,
            itemBuilder: (context, index) {
              final record = _records[index];
              return _buildDataRow(record['timestamp']!, record['value']!);
            },
            separatorBuilder: (context, index) => const Divider(color: Colors.white24, height: 1, indent: 16, endIndent: 16),
          ),
        ],
      ),
    );
  }

  Widget _buildHeaderRow(ThemeData theme) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 12.0),
      child: Row(
        children: [
          const Expanded(
            child: Text(
              'Timestamp',
              style: TextStyle(fontWeight: FontWeight.bold, color: Colors.white70),
            ),
          ),
          Expanded(
            child: DropdownButtonHideUnderline(
              child: DropdownButton<String>(
                value: _selectedCurrent,
                isDense: true,
                isExpanded: true,
                icon: const Icon(Icons.arrow_drop_down, color: Colors.white70),
                style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.white),
                dropdownColor: Colors.grey.shade800,
                onChanged: (String? newValue) {
                  if (newValue != null) {
                    setState(() {
                      _selectedCurrent = newValue;
                    });
                  }
                },
                items: <String>[
                  'Current 1 (kWh)',
                  'Current 2 (kWh)',
                  'Current 3 (kWh)',
                  'Current 4 (kWh)'
                ].map<DropdownMenuItem<String>>((String value) {
                  return DropdownMenuItem<String>(
                    value: value,
                    child: Text(value),
                  );
                }).toList(),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDataRow(String timestamp, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 16.0),
      child: Row(
        children: [
          Expanded(child: Text(timestamp, style: const TextStyle(color: Colors.white70))),
          Expanded(child: Text(value)),
        ],
      ),
    );
  }
}

// ===== lib/features/setup/screens/system_time_screen.dart =====

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:flutter_timezone/flutter_timezone.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/providers/device_provider.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';

class SystemTimeScreen extends StatefulWidget {
  const SystemTimeScreen({Key? key}) : super(key: key);

  @override
  State<SystemTimeScreen> createState() => _SystemTimeScreenState();
}

class _SystemTimeScreenState extends State<SystemTimeScreen> {
  DateTime _selected = DateTime.now();
  bool _isLoading = false;

  Future<void> _pickDate() async {
    final now = DateTime.now();
    final res = await showDatePicker(
      context: context,
      initialDate: _selected,
      firstDate: DateTime(now.year - 10),
      lastDate: DateTime(now.year + 10),
      builder: (context, child) {
        final isDark = Theme.of(context).brightness == Brightness.dark;
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: Theme.of(context).colorScheme.copyWith(
              primary: Theme.of(context).colorScheme.primary,
              surface: isDark ? Colors.black : Colors.white,
              onSurface: isDark ? Colors.white : Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );
    if (res != null) {
      setState(() {
        _selected = DateTime(res.year, res.month, res.day, _selected.hour, _selected.minute);
      });
    }
  }

  Future<void> _pickTime() async {
    final res = await showTimePicker(
      context: context,
      initialTime: TimeOfDay(hour: _selected.hour, minute: _selected.minute),
      builder: (context, child) {
        final isDark = Theme.of(context).brightness == Brightness.dark;
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: Theme.of(context).colorScheme.copyWith(
              primary: Theme.of(context).colorScheme.primary,
              surface: isDark ? Colors.black : Colors.white,
              onSurface: isDark ? Colors.white : Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );
    if (res != null) {
      setState(() {
        _selected = DateTime(_selected.year, _selected.month, _selected.day, res.hour, res.minute);
      });
    }
  }

  Future<void> _setManualTime() async {
    if (_isLoading) return;
    setState(() => _isLoading = true);
    final provider = Provider.of<DeviceProvider>(context, listen: false);
    final device = provider.selectedDevice;

    if (device == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('No device selected.'), backgroundColor: Colors.red),
      );
      setState(() => _isLoading = false);
      return;
    }
    try {
      final iso = _selected.toUtc().toIso8601String();
      final timezone = await FlutterTimezone.getLocalTimezone();
      await ApiService().updateDeviceTimeConfig(
        deviceSerialNumber: device.serialNumber,
        isoTime: iso,
        timezone: timezone.toString(),
      );
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('System time configured successfully.'), backgroundColor: Colors.green),
      );
      Navigator.pushReplacementNamed(context, '/dashboard');
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error sending time: ${e.toString()}'), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;
    final selectedDevice = Provider.of<DeviceProvider>(context, listen: false).selectedDevice;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Column(
            children: [
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
                    ),
                    const Spacer(),
                    Image.asset(AppAssets.logo, height: 36),
                    const SizedBox(width: 8),
                    Text(
                      'AutoAir',
                      style: theme.textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: isDark ? Colors.white : Colors.black,
                      ),
                    ),
                    const Spacer(flex: 2),
                  ],
                ),
              ),
              const SizedBox(height: 12),
              if (selectedDevice == null)
                _buildNoDeviceSelected(isDark)
              else
                _buildTimeSetupBody(theme, isDark),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildNoDeviceSelected(bool isDark) {
    return Expanded(
      child: Center(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.error_outline, color: Colors.amber, size: 48),
              const SizedBox(height: 16),
              Text(
                'No Device Selected',
                textAlign: TextAlign.center,
                style: Theme.of(context).textTheme.headlineSmall,
              ),
              const SizedBox(height: 8),
              Text(
                'Please go back to the device list and select a device to configure.',
                textAlign: TextAlign.center,
                style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                  color: isDark ? Colors.white70 : Colors.black87,
                ),
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () => Navigator.of(context).pop(),
                child: const Text('Go Back'),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTimeSetupBody(ThemeData theme, bool isDark) {
    final dateStr = DateFormat('EEEE, MMM d, yyyy').format(_selected);
    final timeStr = DateFormat('hh:mm a').format(_selected);

    return Expanded(
      child: Column(
        children: [
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  Text(
                    'System Time Setup',
                    textAlign: TextAlign.left,
                    style: theme.textTheme.headlineSmall?.copyWith(
                      fontWeight: FontWeight.w800,
                      letterSpacing: -0.2,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Set the system time manually or connect to Wi-Fi to sync automatically.',
                    style: theme.textTheme.bodyMedium?.copyWith(
                      color: isDark ? Colors.white70 : Colors.black87,
                      height: 1.35,
                    ),
                  ),
                  const SizedBox(height: 20),
                  Container(
                    decoration: BoxDecoration(
                      color: isDark ? Colors.white.withOpacity(0.06) : Colors.white,
                      borderRadius: BorderRadius.circular(14),
                      border: Border.all(color: isDark ? Colors.white12 : Colors.black12),
                    ),
                    child: Column(
                      children: [
                        ListTile(
                          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                          title: const Text('Date'),
                          subtitle: Text(dateStr),
                          trailing: const Icon(Icons.calendar_month),
                          onTap: _pickDate,
                        ),
                        Divider(height: 1, color: isDark ? Colors.white12 : Colors.black12),
                        ListTile(
                          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                          title: const Text('Time'),
                          subtitle: Text(timeStr),
                          trailing: const Icon(Icons.schedule),
                          onTap: _pickTime,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),
                  Container(
                    decoration: BoxDecoration(
                      color: isDark ? Colors.white.withOpacity(0.06) : Colors.white,
                      borderRadius: BorderRadius.circular(14),
                      border: Border.all(color: isDark ? Colors.white12 : Colors.black12),
                    ),
                    child: Column(
                      children: [
                        ListTile(
                          contentPadding: const EdgeInsets.symmetric(horizontal: 16),
                          title: const Text('Selected (Local)'),
                          subtitle: Text(
                            DateFormat('yyyy-MM-dd  hh:mm a').format(_selected),
                          ),
                          trailing: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(20),
                              color: isDark ? Colors.white10 : Colors.black.withOpacity(0.05),
                            ),
                            child: Text(
                              DateFormat('zzz').format(_selected),
                              style: theme.textTheme.labelMedium,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
          SafeArea(
            top: false,
            child: Padding(
              padding: const EdgeInsets.fromLTRB(20, 8, 20, 16),
              child: Column(
                children: [
                  SizedBox(
                    width: double.infinity,
                    height: 52,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _setManualTime,
                      child: _isLoading
                          ? const SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
                      )
                          : const Text('Set Time Manually'),
                    ),
                  ),
                  const SizedBox(height: 10),
                  SizedBox(
                    width: double.infinity,
                    height: 52,
                    child: OutlinedButton(
                      onPressed: () {
                        Navigator.pushNamed(context, '/wifi_onboarding');
                      },
                      child: const Text('Connect to Wi-Fi (Auto-sync)'),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// ===== lib/features/setup/screens/wifi_onboarding_screen.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';

class WifiOnboardingScreen extends StatelessWidget {
  const WifiOnboardingScreen({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Column(
            children: [
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
                    ),
                    const Spacer(),
                    Image.asset(AppAssets.logo, height: 36),
                    const SizedBox(width: 8),
                    Text(
                      'AutoAir',
                      style: theme.textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: isDark ? Colors.white : Colors.black,
                      ),
                    ),
                    const Spacer(flex: 2),
                  ],
                ),
              ),
              const SizedBox(height: 12),
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                  children: [
                    Text(
                      'Wi-Fi Setup',
                      style: theme.textTheme.headlineSmall?.copyWith(
                        fontWeight: FontWeight.w800,
                        letterSpacing: -0.2,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'To sync your device time automatically, it needs to connect to the internet. Please select your Wi-Fi network and enter the password.',
                      style: theme.textTheme.bodyMedium?.copyWith(
                        color: isDark ? Colors.white70 : Colors.black87,
                        height: 1.35,
                      ),
                    ),
                    const SizedBox(height: 24),
                    Container(
                      padding: const EdgeInsets.all(24),
                      decoration: BoxDecoration(
                        color: isDark ? Colors.white.withOpacity(0.06) : Colors.white,
                        borderRadius: BorderRadius.circular(14),
                        border: Border.all(color: isDark ? Colors.white12 : Colors.black12),
                      ),
                      child: Column(
                        children: [
                          Icon(Icons.wifi_find, size: 64, color: isDark ? Colors.white70 : Colors.black87),
                          const SizedBox(height: 16),
                          Text(
                            'Device Provisioning',
                            textAlign: TextAlign.center,
                            style: theme.textTheme.titleLarge,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                          const SizedBox(height: 8),
                          Text(
                            'The app will now scan for the device. Make sure your device is powered on and in pairing mode.',
                            textAlign: TextAlign.center,
                            style: theme.textTheme.bodyMedium?.copyWith(
                              color: isDark ? Colors.white70 : Colors.black87,
                              height: 1.35,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        bottomNavigationBar: SafeArea(
          minimum: const EdgeInsets.fromLTRB(20, 8, 20, 16),
          child: ConstrainedBox(
            constraints: const BoxConstraints(minHeight: 52),
            child: SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  minimumSize: const Size.fromHeight(52),
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                ),
                onPressed: () => Navigator.pushNamed(context, '/wifi_scan'),
                child: const FittedBox(
                  fit: BoxFit.scaleDown,
                  child: Text('Begin Scan'),
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}


// ===== lib/features/setup/screens/wifi_password_screen.dart =====

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:dio/dio.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/providers/device_provider.dart';
import 'package:AutoAir/widgets/app_background.dart';

class WifiPasswordScreen extends StatefulWidget {
  const WifiPasswordScreen({Key? key}) : super(key: key);

  @override
  State<WifiPasswordScreen> createState() => _WifiPasswordScreenState();
}

class _WifiPasswordScreenState extends State<WifiPasswordScreen> {
  final _formKey = GlobalKey<FormState>();
  bool _useStaticIp = false;
  bool _isPasswordObscured = true;
  bool _isLoading = false;

  final _ssidController = TextEditingController();
  final _passwordController = TextEditingController();
  final _ipAddressController = TextEditingController();
  final _subnetController = TextEditingController();
  final _gatewayController = TextEditingController();

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    final ssid = ModalRoute.of(context)?.settings.arguments as String?;
    if (ssid != null && ssid.isNotEmpty) {
      _ssidController.text = ssid;
    }
  }

  @override
  void dispose() {
    _ssidController.dispose();
    _passwordController.dispose();
    _ipAddressController.dispose();
    _subnetController.dispose();
    _gatewayController.dispose();
    super.dispose();
  }

  Future<void> _handleConnect() async {
    if (!(_formKey.currentState?.validate() ?? false)) return;

    setState(() => _isLoading = true);

    final deviceProvider = Provider.of<DeviceProvider>(context, listen: false);
    final device = deviceProvider.selectedDevice;

    if (device == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('No device is selected for configuration.'), backgroundColor: Colors.red),
      );
      setState(() => _isLoading = false);
      return;
    }

    try {
      await ApiService().updateDeviceWifiConfig(
        deviceSerialNumber: device.serialNumber,
        ssid: _ssidController.text,
        password: _passwordController.text,
        isStatic: _useStaticIp,
        ipAddress: _ipAddressController.text,
        subnet: _subnetController.text,
        gateway: _gatewayController.text,
      );

      _onSuccess();

    } on DioException catch (e) {
      if (e.response?.statusCode == 503 && e.response?.data['message'].contains('Device unreachable')) {
        _onSuccess();
      } else {
        String errorMessage = "An unknown error occurred.";
        if (e.response?.data is Map && e.response?.data['message'] != null) {
          errorMessage = e.response!.data['message'];
        }
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMessage), backgroundColor: Colors.red),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to send credentials: ${e.toString()}'), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _onSuccess() async {
    final deviceProvider = Provider.of<DeviceProvider>(context, listen: false);
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Wi-Fi credentials sent successfully.'), backgroundColor: Colors.green),
    );

    await deviceProvider.fetchDevices();

    if (mounted) {
      Navigator.of(context).popUntil((route) => route.isFirst);
      Navigator.of(context).pushReplacementNamed('/dashboard');
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Form(
            key: _formKey,
            child: Column(
              children: [
                const SizedBox(height: 12),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: Row(
                    children: [
                      IconButton(
                        onPressed: () => Navigator.pop(context),
                        icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
                      ),
                      const Spacer(),
                      Text(
                        'Connect to Wi-Fi',
                        style: theme.textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w800, color: isDark ? Colors.white : Colors.black),
                      ),
                      const Spacer(flex: 2),
                    ],
                  ),
                ),
                const SizedBox(height: 12),
                Expanded(
                  child: ListView(
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                    children: [
                      _buildTextField(_ssidController, 'Wi-Fi Name', hint: 'Enter network name (SSID)', isRequired: true),
                      const SizedBox(height: 16),
                      _buildTextField(_passwordController, 'Password', hint: 'Enter network password', isObscured: true, isRequired: true),
                      const SizedBox(height: 8),
                      _buildStaticIpCheckbox(isDark),
                      if (_useStaticIp) ..._buildStaticIpFields(),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
        bottomNavigationBar: SafeArea(
          child: Padding(
            padding: const EdgeInsets.fromLTRB(20, 8, 20, 16),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                SizedBox(
                  width: double.infinity,
                  height: 52,
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _handleConnect,
                    child: _isLoading
                        ? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
                        : const Text('Connect'),
                  ),
                ),
                const SizedBox(height: 10),
                SizedBox(
                  width: double.infinity,
                  height: 52,
                  child: OutlinedButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel'),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTextField(TextEditingController controller, String label, {required String hint, bool isObscured = false, bool isRequired = false}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: Theme.of(context).textTheme.bodyMedium),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          obscureText: isObscured ? _isPasswordObscured : false,
          decoration: InputDecoration(
            hintText: hint,
            suffixIcon: isObscured
                ? IconButton(
              icon: Icon(_isPasswordObscured ? Icons.visibility_off : Icons.visibility),
              onPressed: () => setState(() => _isPasswordObscured = !_isPasswordObscured),
            )
                : null,
          ),
          validator: (value) {
            if (isRequired && (value == null || value.isEmpty)) {
              return 'This field is required';
            }
            return null;
          },
        ),
      ],
    );
  }

  Widget _buildStaticIpCheckbox(bool isDark) {
    return Row(
      children: [
        Checkbox(
          value: _useStaticIp,
          onChanged: (value) => setState(() => _useStaticIp = value ?? false),
          side: BorderSide(color: isDark ? Colors.white70 : Colors.black87),
        ),
        GestureDetector(
          onTap: () => setState(() => _useStaticIp = !_useStaticIp),
          child: Text('Use Static IP', style: Theme.of(context).textTheme.bodyMedium),
        ),
      ],
    );
  }

  List<Widget> _buildStaticIpFields() {
    return [
      const SizedBox(height: 16),
      _buildTextField(_ipAddressController, 'IP Address', hint: 'e.g., 192.1.1.100', isRequired: _useStaticIp),
      const SizedBox(height: 16),
      _buildTextField(_subnetController, 'Subnet Mask', hint: 'e.g., 255.255.255.0', isRequired: _useStaticIp),
      const SizedBox(height: 16),
      _buildTextField(_gatewayController, 'Gateway', hint: 'e.g., 192.1.1.1', isRequired: _useStaticIp),
    ];
  }
}

// ===== lib/features/setup/screens/wifi_scan_screen.dart =====

import 'package:flutter/material.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:location/location.dart' as loc;
import 'package:wifi_scan/wifi_scan.dart';
import 'package:AutoAir/utils/app_assets.dart';
import 'package:AutoAir/widgets/app_background.dart';

class WifiScanScreen extends StatefulWidget {
  const WifiScanScreen({Key? key}) : super(key: key);

  @override
  State<WifiScanScreen> createState() => _WifiScanScreenState();
}

class _WifiScanScreenState extends State<WifiScanScreen> {
  List<WiFiAccessPoint> _accessPoints = [];
  bool _isLoading = true;
  String? _error;

  @override
  void initState() {
    super.initState();
    _startScan();
  }

  Future<void> _startScan() async {
    setState(() {
      _isLoading = true;
      _error = null;
    });

    if (await _checkPermissionsAndServices()) {
      await _executeScan();
    }

    if(mounted) {
      setState(() => _isLoading = false);
    }
  }

  Future<bool> _checkPermissionsAndServices() async {
    final permissionStatus = await Permission.locationWhenInUse.request();
    if (permissionStatus.isDenied || permissionStatus.isPermanentlyDenied) {
      setState(() => _error = "Location permission is required to scan for Wi-Fi networks.");
      return false;
    }

    final location = loc.Location();
    bool serviceEnabled = await location.serviceEnabled();
    if (!serviceEnabled) {
      serviceEnabled = await location.requestService();
      if (!serviceEnabled) {
        setState(() => _error = "Please enable Location/GPS in your phone's settings.");
        return false;
      }
    }
    return true;
  }

  Future<void> _executeScan() async {
    final canScan = await WiFiScan.instance.canStartScan();
    if (canScan != CanStartScan.yes) {
      setState(() => _error = "Wi-Fi scanning is not available on this device.");
      return;
    }

    await WiFiScan.instance.startScan();
    final results = await WiFiScan.instance.getScannedResults();
    if(mounted) {
      setState(() => _accessPoints = results);
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return AppBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: SafeArea(
          child: Column(
            children: [
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.arrow_back, color: isDark ? Colors.white : Colors.black),
                    ),
                    const Spacer(),
                    Image.asset(AppAssets.logo, height: 36),
                    const SizedBox(width: 8),
                    Text(
                      'AutoAir',
                      style: theme.textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: isDark ? Colors.white : Colors.black,
                      ),
                    ),
                    const Spacer(flex: 2),
                  ],
                ),
              ),
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Text(
                      'Available Networks',
                      style: theme.textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.w800, letterSpacing: -0.2),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Select a Wi-Fi network to connect your device.',
                      style: theme.textTheme.bodyMedium?.copyWith(color: isDark ? Colors.white70 : Colors.black87, height: 1.35),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 8),
              Expanded(child: _buildBody(isDark)),
            ],
          ),
        ),
        bottomNavigationBar: SafeArea(
          child: Padding(
            padding: const EdgeInsets.fromLTRB(20, 8, 20, 16),
            child: SizedBox(
              width: double.infinity,
              height: 52,
              child: OutlinedButton.icon(
                icon: const Icon(Icons.add),
                label: const Text('Add Wi-Fi Manually'),
                onPressed: () => Navigator.pushNamed(context, '/wifi_password'),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBody(bool isDark) {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }
    if (_error != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: Text(_error!, textAlign: TextAlign.center, style: TextStyle(color: Colors.red.shade300)),
        ),
      );
    }
    if (_accessPoints.isEmpty) {
      return const Center(child: Text('No Wi-Fi networks found. Pull to refresh.'));
    }

    return RefreshIndicator(
      onRefresh: _startScan,
      child: ListView.builder(
        padding: const EdgeInsets.symmetric(horizontal: 20),
        itemCount: _accessPoints.length,
        itemBuilder: (context, index) {
          final ap = _accessPoints[index];
          return Card(
            margin: const EdgeInsets.only(bottom: 8),
            color: isDark ? Colors.white.withOpacity(0.06) : Colors.white,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(14),
              side: BorderSide(color: isDark ? Colors.white12 : Colors.black12),
            ),
            child: ListTile(
              title: Text(ap.ssid.isNotEmpty ? ap.ssid : '(hidden network)'),
              trailing: Icon(_getWifiIcon(ap.level)),
              onTap: () => Navigator.pushNamed(context, '/wifi_password', arguments: ap.ssid),
            ),
          );
        },
      ),
    );
  }

  IconData _getWifiIcon(int level) {
    if (level > -60) return Icons.wifi;
    if (level > -75) return Icons.wifi_2_bar;
    return Icons.wifi_1_bar;
  }
}

// ===== lib/providers/dashboard_provider.dart =====

import 'package:flutter/material.dart';
import 'package:AutoAir/providers/device_provider.dart';
import 'package:AutoAir/features/devices/models/device_model.dart';
import 'package:AutoAir/features/dashboard/models/relay_model.dart';
import 'package:AutoAir/api/api_service.dart';

class DashboardProvider with ChangeNotifier {
  final DeviceProvider _deviceProvider;
  final ApiService _apiService = ApiService();

  bool _isLoading = true;
  String? _error;
  Device? _selectedDevice;

  double? _temperature;
  double? _humidity;
  double? _heatIndex;

  String _mode = '...';
  double _totalKwh = 0.0;
  bool _isPowerOn = false;

  List<Relay> _relays = [];

  bool get isLoading => _isLoading;
  String? get error => _error;
  Device? get selectedDevice => _selectedDevice;
  double? get temperature => _temperature;
  double? get humidity => _humidity;
  double? get heatIndex => _heatIndex;
  String get mode => _mode;
  double get totalKwh => _totalKwh;
  bool get isPowerOn => _isPowerOn;
  List<Relay> get relays => _relays;

  DashboardProvider(this._deviceProvider) {
    _deviceProvider.addListener(_onDeviceChanged);
    _selectedDevice = _deviceProvider.selectedDevice;
    if (_selectedDevice != null) {
      _fetchDashboardData();
    }
  }

  @override
  void dispose() {
    _deviceProvider.removeListener(_onDeviceChanged);
    super.dispose();
  }

  void _onDeviceChanged() {
    if (_deviceProvider.selectedDevice != _selectedDevice) {
      _selectedDevice = _deviceProvider.selectedDevice;
      if (_selectedDevice != null) {
        _fetchDashboardData();
      } else {
        _clearData();
      }
    }
  }

  void _clearData() {
    _isLoading = true;
    _relays = [];
    _temperature = null;
    _humidity = null;
    _heatIndex = null;
    _mode = '...';
    _totalKwh = 0.0;
    _isPowerOn = false;
    notifyListeners();
  }

  Future<void> _fetchDashboardData() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    await Future.delayed(const Duration(milliseconds: 500));

    if (_selectedDevice == null) {
      _error = "No device selected.";
      _isLoading = false;
      notifyListeners();
      return;
    }

    try {
      _temperature = 24.0;
      _humidity = 48.0;
      _heatIndex = 25.0;
      _mode = "Auto";
      _totalKwh = 48.0;
      _isPowerOn = false;
      _relays = [
        Relay(id: 1, name: 'Relay 1', amperage: 12.34, isOn: false),
        Relay(id: 2, name: 'Relay 2', amperage: 56.78, isOn: true),
        Relay(id: 3, name: 'Relay 3', amperage: 0.00, isOn: false),
      ];
    } catch (e) {
      _error = "Failed to load dashboard data.";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> toggleRelay(int relayId, bool newState) async {
    if (_selectedDevice == null) return;

    final originalStates = _relays.map((r) => r.isOn).toList();

    if (newState) {
      for (var relay in _relays) {
        relay.isOn = (relay.id == relayId);
      }
    } else {
      final relayIndex = _relays.indexWhere((r) => r.id == relayId);
      if (relayIndex != -1) {
        _relays[relayIndex].isOn = false;
      }
    }
    notifyListeners();

    final Map<String, dynamic> relaysPayload = {
      for (var relay in _relays)
        relay.id.toString(): {'is_on': relay.isOn}
    };

    try {
      await _apiService.updateDevice(
        serialNumber: _selectedDevice!.serialNumber,
        data: {
          'config': {'relays': relaysPayload}
        },
      );
    } catch (e) {
      for (int i = 0; i < _relays.length; i++) {
        _relays[i].isOn = originalStates[i];
      }
      _error = "Failed to update relay state.";
      notifyListeners();
    }
  }
}

// ===== lib/providers/device_provider.dart =====

import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:AutoAir/api/api_service.dart';
import 'package:AutoAir/features/devices/models/device_model.dart';

class DeviceProvider with ChangeNotifier {
  final ApiService _apiService = ApiService();
  static const _activeDeviceKey = 'active_device_serial';

  List<Device> _devices = [];
  Device? _selectedDevice;
  bool _isLoading = false;
  String? _error;

  List<Device> get devices => _devices;
  Device? get selectedDevice => _selectedDevice;
  bool get isLoading => _isLoading;
  String? get error => _error;

  void selectDevice(Device? device) {
    if (_selectedDevice != device) {
      _selectedDevice = device;
      notifyListeners();
    }
  }

  Future<void> persistActiveDevice(Device device) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_activeDeviceKey, device.serialNumber);
    selectDevice(device);
  }

  Future<void> clearActiveDevice() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_activeDeviceKey);
  }

  Future<bool> loadInitialDevice() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final serial = prefs.getString(_activeDeviceKey);
      if (serial == null || serial.isEmpty) return false;

      await fetchDevices();
      final activeDevice = _devices.firstWhere((d) => d.serialNumber == serial);
      _selectedDevice = activeDevice;
      notifyListeners();
      return true;
    } catch (e) {
      await clearActiveDevice();
      return false;
    }
  }

  Future<void> fetchDevices() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final deviceData = await _apiService.getDevices();
      _devices = deviceData.map((data) => Device.fromJson(data)).toList();
    } catch (e) {
      _error = e.toString();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> addDevice({
    required String name,
    required String serialNumber,
    required String pin,
    String? description,
  }) async {
    _isLoading = true;
    notifyListeners();

    try {
      await _apiService.createDevice(
        name: name,
        serialNumber: serialNumber,
        pin: pin,
        description: description,
      );
      await fetchDevices();
    } on DioException catch (e) {
      String errorMessage = "Failed to add device. Please try again.";
      if (e.response?.data is Map && e.response!.data['message'] != null) {
        String serverMessage = e.response!.data['message'];
        if (serverMessage.contains('COMFAC service')) {
          errorMessage = "An unexpected server error occurred. Please try again later.";
        } else {
          errorMessage = serverMessage;
        }
      }
      _error = errorMessage;
      notifyListeners();
      throw Exception(errorMessage);
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      rethrow;
    }
  }
}

// ===== lib/themes/custom_colors.dart =====

import 'package:flutter/material.dart';

@immutable
class CustomColors extends ThemeExtension<CustomColors> {
  const CustomColors({
    required this.primaryAction,
    required this.secondaryButton,
    required this.success,
    required this.successTrack,
    required this.successBorder,
  });

  final Color primaryAction;
  final Color secondaryButton;

  final Color success;
  final Color successTrack;
  final Color successBorder;

  @override
  CustomColors copyWith({
    Color? primaryAction,
    Color? secondaryButton,
    Color? success,
    Color? successTrack,
    Color? successBorder,
  }) {
    return CustomColors(
      primaryAction: primaryAction ?? this.primaryAction,
      secondaryButton: secondaryButton ?? this.secondaryButton,
      success: success ?? this.success,
      successTrack: successTrack ?? this.successTrack,
      successBorder: successBorder ?? this.successBorder,
    );
  }

  @override
  ThemeExtension<CustomColors> lerp(ThemeExtension<CustomColors>? other, double t) {
    if (other is! CustomColors) return this;
    return CustomColors(
      primaryAction: Color.lerp(primaryAction, other.primaryAction, t)!,
      secondaryButton: Color.lerp(secondaryButton, other.secondaryButton, t)!,
      success: Color.lerp(success, other.success, t)!,
      successTrack: Color.lerp(successTrack, other.successTrack, t)!,
      successBorder: Color.lerp(successBorder, other.successBorder, t)!,
    );
  }
}


// ===== lib/utils/app_assets.dart =====

class AppAssets {
  AppAssets._();

  static const String _imagesPath = 'assets/images';

  static const String logo = '$_imagesPath/logo.png';
  static const String background = '$_imagesPath/bg.png';
}

// ===== lib/widgets/app_background.dart =====

import 'package:flutter/material.dart';

class AppBackground extends StatelessWidget {
  const AppBackground({
    super.key,
    required this.child,
    this.intensity = 1.0,
  });

  final Widget child;
  final double intensity;

  @override
  Widget build(BuildContext context) {
    final t = intensity.clamp(0.0, 1.0);

    final baseGradient = LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: const [
        Color(0xFF0B0713),
        Color(0xFF140A26),
        Color(0xFF1A0C2E),
        Color(0xFF2B1055),
      ].map((c) => _lerpColor(c, Colors.black, 0.15 * t)).toList(),
      stops: const [0.0, 0.35, 0.62, 1.0],
    );

    final brGlow = RadialGradient(
      center: const Alignment(0.75, 0.65),
      radius: 0.85,
      colors: [
        const Color(0xFF6A2BC2).withOpacity(0.35 * (1.0 - 0.4 * t)),
        const Color(0xFF42177F).withOpacity(0.22 * (1.0 - 0.3 * t)),
        Colors.transparent,
      ],
      stops: const [0.0, 0.35, 1.0],
    );

    final tlGlow = RadialGradient(
      center: const Alignment(-0.9, -0.9),
      radius: 1.1,
      colors: [
        const Color(0xFF2A1F5E).withOpacity(0.28 * (1.0 - 0.4 * t)),
        const Color(0xFF1A1240).withOpacity(0.18 * (1.0 - 0.3 * t)),
        Colors.transparent,
      ],
      stops: const [0.0, 0.45, 1.0],
    );

    final vignette = RadialGradient(
      center: Alignment.center,
      radius: 1.0,
      colors: [
        Colors.transparent,
        Colors.black.withOpacity(0.40 + 0.25 * t),
      ],
      stops: const [0.70, 1.0],
    );

    return Stack(
      fit: StackFit.expand,
      children: [
        DecoratedBox(
          decoration: BoxDecoration(gradient: baseGradient),
        ),
        DecoratedBox(
          decoration: BoxDecoration(gradient: tlGlow),
        ),
        DecoratedBox(
          decoration: BoxDecoration(gradient: brGlow),
        ),
        DecoratedBox(
          decoration: BoxDecoration(gradient: vignette),
        ),
        child,
      ],
    );
  }

  Color _lerpColor(Color a, Color b, double t) => Color.lerp(a, b, t) ?? a;
}

